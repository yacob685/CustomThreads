<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CustomThreads - Premium Custom Printed Apparel</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: #ffffff;
        }

        /* Modal Base Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #e5e7eb;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #d1d5db;
        }

      header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .top-bar {
            background: #1a1a1a;
            color: #ffffff;
            padding: 0.6rem 0;
            font-size: 0.85rem;
            text-align: center;
        }

    nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1a1a1a;
            cursor: pointer;
            letter-spacing: -0.5px;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            list-style: none;
        }

        .nav-links button {
            background: none;
            border: none;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: color 0.2s;
            font-family: inherit;
        }

        a {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.2s;
        }
        .nav-links button:hover {
            color: #1a1a1a;
        }

        .nav-actions {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-actions button {
            background: none;
            border: none;
            color: #4a5568;
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .nav-actions button:hover {
            color: #1a1a1a;
        }

        .cart-badge {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc2626;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            padding: 5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .hero-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            align-items: center;
        }

        .hero-content h1 {
            font-size: 3.5rem;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            color: #1a1a1a;
            font-weight: 700;
        }

        .hero-content p {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 2rem;
            line-height: 1.7;
        }

        .hero-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            padding: 1rem 2.5rem;
            border-radius: 6px;
            font-weight: 600;
            transition: background 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background: #2d2d2d;
        }

        .btn-secondary {
            background: white;
            color: #1a1a1a;
            padding: 1rem 2.5rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-secondary:hover {
            border-color: #1a1a1a;
        }

        .hero-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .hero-image {
            background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
            border-radius: 12px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border: 1px solid #e5e7eb;
        }

        /* Trust Section */
        .trust-section {
            padding: 3rem 2rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .trust-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3rem;
        }

        .trust-item {
            text-align: center;
        }

        .trust-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .trust-item h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
            font-weight: 600;
        }

        .trust-item p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Categories */
        .categories {
            padding: 5rem 2rem;
            background: white;
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-header h2 {
            font-size: 2.5rem;
            color: #1a1a1a;
            margin-bottom: 0.8rem;
            font-weight: 700;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #6b7280;
        }

        .category-grid {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .category-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-card:hover {
            border-color: #1a1a1a;
            transform: translateY(-4px);
        }

        .category-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .category-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        .category-card p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Products Section */
        .products {
            padding: 5rem 2rem;
            background: #f9fafb;
        }

        .product-grid {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .product-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-4px);
        }

        .product-image {
            background: #f3f4f6;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6rem;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .product-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: #1a1a1a;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-category {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
            color: #1a1a1a;
            font-weight: 600;
        }

        .product-price {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .price-current {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .price-original {
            font-size: 1rem;
            color: #9ca3af;
            text-decoration: line-through;
        }

        .product-colors {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-dot:hover {
            transform: scale(1.15);
        }

        .product-button {
            width: 100%;
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 0.9rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .product-button:hover {
            background: #2d2d2d;
        }

        /* Cart Styles */
        .cart-items {
            margin: 1.5rem 0;
        }

        .cart-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            background: #f3f4f6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-details h4 {
            margin-bottom: 0.3rem;
        }

        .cart-item-details p {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .cart-item-price {
            font-weight: 700;
            color: #1a1a1a;
        }

        .cart-total {
            border-top: 2px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-total-label {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .cart-total-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .empty-cart {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        /* Design Studio */
        .design-studio {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .design-canvas {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .design-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-group {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .control-group input,
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Payment Buttons */
        .payment-options {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .payment-button {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .payment-button:hover {
            border-color: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .payment-button.paypal {
            background: #0070ba;
            color: white;
            border-color: #0070ba;
        }

        .payment-button.stripe {
            background: #635bff;
            color: white;
            border-color: #635bff;
        }

        /* Footer */
        footer {
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            padding: 4rem 2rem 2rem;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }

        .footer-brand h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }

        .footer-brand p {
            color: #6b7280;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        .footer-section h4 {
            margin-bottom: 1rem;
            color: #1a1a1a;
            font-weight: 600;
        }

        .footer-section button {
            background: none;
            border: none;
            color: #6b7280;
            text-align: left;
            padding: 0;
            margin-bottom: 0.6rem;
            cursor: pointer;
            font-size: 0.95rem;
            transition: color 0.2s;
        }

        .footer-section button:hover {
            color: #1a1a1a;
        }

        .footer-bottom {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 0.6rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .hero-container {
                grid-template-columns: 1fr;
            }

            .category-grid, .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .design-studio {
                grid-template-columns: 1fr;
            }

            .footer-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .hero-content h1 {
                font-size: 2.5rem;
            }

            .trust-container {
                grid-template-columns: 1fr 1fr;
            }

            .category-grid, .product-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }


        /* Advanced Cart Modal */
#advanced-cart-modal {
    position: fixed;
    top: 0;
    right: -100%;
    width: 100%;
    max-width: 480px;
    height: 100vh;
    background: #ffffff;
    box-shadow: -4px 0 24px rgba(0,0,0,0.15);
    z-index: 99999;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

#advanced-cart-modal.open {
    right: 0;
}

.cart-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 99998;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s;
}

.cart-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.cart-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9fafb;
}

.cart-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
}

.cart-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.2s;
}

.cart-close-btn:hover {
    background: #e5e7eb;
}

.cart-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.cart-empty {
    text-align: center;
    padding: 3rem 1.5rem;
    color: #6b7280;
}

.cart-empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

.advanced-cart-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 12px;
    margin-bottom: 1rem;
    position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
}

.advanced-cart-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.cart-item-img {
    width: 90px;
    height: 90px;
    border-radius: 8px;
    object-fit: cover;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    flex-shrink: 0;
}

.cart-item-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.cart-item-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1a1a1a;
    margin-bottom: 0.25rem;
}

.cart-item-details {
    font-size: 0.8rem;
    color: #6b7280;
}

.cart-item-price {
    font-weight: 700;
    color: #1a1a1a;
    font-size: 1.1rem;
    margin-top: 0.5rem;
}

.cart-item-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.qty-control {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.25rem;
}

.qty-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: #f3f4f6;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qty-btn:hover {
    background: #e5e7eb;
}

.qty-btn:active {
    transform: scale(0.95);
}

.qty-display {
    min-width: 32px;
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.remove-btn {
    background: none;
    border: none;
    color: #ef4444;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background 0.2s;
    font-size: 1.1rem;
}

.remove-btn:hover {
    background: #fee2e2;
}

.cart-footer {
    border-top: 1px solid #e5e7eb;
    padding: 1.5rem;
    background: #f9fafb;
}

.cart-summary {
    margin-bottom: 1rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    color: #6b7280;
    font-size: 0.95rem;
}

.summary-row.total {
    border-top: 2px solid #e5e7eb;
    padding-top: 1rem;
    margin-top: 0.5rem;
    font-weight: 700;
    font-size: 1.2rem;
    color: #1a1a1a;
}

.checkout-btn {
    width: 100%;
    padding: 1rem;
    background: #1a1a1a;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s, transform 0.1s;
}

.checkout-btn:hover {
    background: #2d2d2d;
    transform: translateY(-1px);
}

.checkout-btn:active {
    transform: translateY(0);
}

.continue-shopping {
    width: 100%;
    padding: 0.75rem;
    background: transparent;
    color: #6b7280;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: all 0.2s;
}

.continue-shopping:hover {
    background: #f9fafb;
    color: #1a1a1a;
    border-color: #d1d5db;
}

@media (max-width: 640px) {
    #advanced-cart-modal {
        max-width: 100%;
    }
}


        /* Advanced Checkout Modal */
.checkout-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    overflow-y: auto;
}

.checkout-modal-overlay.active {
    display: flex;
}

.checkout-modal-content {
    background: white;
    border-radius: 16px;
    max-width: 900px;
    width: 100%;
    max-height: 95vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.checkout-header {
    padding: 2rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9fafb;
}

.checkout-header h2 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
}

.checkout-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    padding: 2rem;
}

.checkout-section {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.checkout-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.form-field {
    margin-bottom: 1rem;
}

.form-field label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    font-size: 0.9rem;
    color: #374151;
}

.form-field input,
.form-field select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.form-field input:focus,
.form-field select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.order-summary-item {
    display: flex;
    gap: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    border: 1px solid #e5e7eb;
}

.summary-item-img {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.summary-item-details {
    flex: 1;
    font-size: 0.85rem;
}

.summary-item-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.summary-item-meta {
    color: #6b7280;
    font-size: 0.8rem;
}

.summary-item-price {
    text-align: right;
    font-weight: 700;
}

.summary-totals {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px solid #e5e7eb;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    font-size: 0.95rem;
}

.summary-row.total {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1a1a1a;
    padding-top: 1rem;
    margin-top: 0.5rem;
    border-top: 2px solid #e5e7eb;
}

.payment-methods {
    display: grid;
    gap: 1rem;
    margin-top: 1.5rem;
}

.payment-method-btn {
    padding: 1.25rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
}

.payment-method-btn:hover {
    border-color: #1a1a1a;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.payment-method-btn.paypal {
    background: #0070ba;
    color: white;
    border-color: #0070ba;
}

.payment-method-btn.stripe {
    background: #635bff;
    color: white;
    border-color: #635bff;
}

.payment-method-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .checkout-body {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}

        /* Advanced Account System */
.account-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.account-modal.active {
    display: flex;
}

.account-card {
    background: white;
    border-radius: 16px;
    max-width: 480px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.account-header {
    padding: 2rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.account-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
}

.account-body {
    padding: 2rem;
}

.account-menu {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.account-menu-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.account-menu-item:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    transform: translateX(4px);
}

.account-menu-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 8px;
}

.account-menu-content {
    flex: 1;
}

.account-menu-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #1a1a1a;
}

.account-menu-desc {
    font-size: 0.85rem;
    color: #6b7280;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.auth-input {
    width: 100%;
    padding: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.auth-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

.auth-btn {
    width: 100%;
    padding: 1rem;
    background: #1a1a1a;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}

.auth-btn:hover {
    background: #2d2d2d;
}

.auth-btn-secondary {
    background: transparent;
    color: #1a1a1a;
    border: 1px solid #e5e7eb;
}

.auth-btn-secondary:hover {
    background: #f9fafb;
}

.auth-link {
    text-align: center;
    color: #3b82f6;
    cursor: pointer;
    font-size: 0.9rem;
    text-decoration: underline;
}

.auth-link:hover {
    color: #2563eb;
}

.auth-divider {
    text-align: center;
    color: #6b7280;
    margin: 1rem 0;
    position: relative;
}

.auth-divider::before,
.auth-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #e5e7eb;
}

.auth-divider::before {
    left: 0;
}

.auth-divider::after {
    right: 0;
}

.welcome-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
}

.welcome-banner h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
}

.welcome-banner p {
    margin: 0;
    opacity: 0.9;
}

.error-message {
    background: #fee2e2;
    color: #991b1b;
    padding: 0.75rem;
    border-radius: 6px;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.success-message {
    background: #d1fae5;
    color: #065f46;
    padding: 0.75rem;
    border-radius: 6px;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.order-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.order-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.order-id {
    font-weight: 600;
    color: #1a1a1a;
}

.order-date {
    color: #6b7280;
    font-size: 0.85rem;
}

.order-total {
    font-weight: 700;
    color: #1a1a1a;
}

.order-items {
    color: #6b7280;
    font-size: 0.85rem;
}


        /* Enhanced Account Modal */
.account-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(4px);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.account-modal.active {
    display: flex;
}

.account-card {
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    border-radius: 20px;
    max-width: 920px;
    width: 100%;
    max-height: 92vh;
    overflow: hidden;
    box-shadow: 0 25px 70px rgba(0,0,0,0.25);
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.account-header {
    padding: 2rem 2.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: white;
}

.account-header h2 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.account-body {
    padding: 2rem 2.5rem;
    max-height: calc(92vh - 100px);
    overflow-y: auto;
}

/* Scrollbar styling */
.account-body::-webkit-scrollbar {
    width: 8px;
}

.account-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.account-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.account-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Welcome Banner */
.welcome-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.welcome-banner h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    font-weight: 700;
}

.welcome-banner p {
    margin: 0;
    opacity: 0.95;
    font-size: 1rem;
}

/* Account Menu Grid */
.account-menu {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

.account-menu-item {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.5rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.account-menu-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    transition: width 0.4s ease;
}

.account-menu-item:hover::before {
    width: 100%;
}

.account-menu-item:hover {
    border-color: #667eea;
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(102, 126, 234, 0.2);
}

.account-menu-icon {
    font-size: 2rem;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-radius: 12px;
    flex-shrink: 0;
    transition: transform 0.3s ease;
}

.account-menu-item:hover .account-menu-icon {
    transform: scale(1.1) rotate(5deg);
}

.account-menu-content {
    flex: 1;
    position: relative;
    z-index: 1;
}

.account-menu-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #1a1a1a;
    font-size: 1.05rem;
}

.account-menu-desc {
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.4;
}

/* Order Cards */
.order-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 14px;
    padding: 1.5rem;
    margin-bottom: 1.25rem;
    transition: all 0.3s ease;
    position: relative;
}

.order-card:hover {
    border-color: #667eea;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f3f4f6;
}

.order-id {
    font-weight: 700;
    color: #1a1a1a;
    font-size: 1.05rem;
    margin-bottom: 0.25rem;
}

.order-date {
    color: #6b7280;
    font-size: 0.875rem;
}

.order-status {
    display: inline-block;
    padding: 0.35rem 0.85rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.order-status.completed {
    background: #d1fae5;
    color: #065f46;
}

.order-status.processing {
    background: #dbeafe;
    color: #1e40af;
}

.order-status.cancelled {
    background: #fee2e2;
    color: #991b1b;
}

.order-items-preview {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.order-item-mini {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #f9fafb;
    border-radius: 8px;
    font-size: 0.875rem;
}

.order-item-mini-icon {
    font-size: 1.25rem;
}

.order-total-display {
    font-weight: 700;
    font-size: 1.35rem;
    color: #1a1a1a;
    text-align: right;
}

.order-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
}

.order-action-btn {
    padding: 0.6rem 1.25rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.order-action-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.order-action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.order-action-btn.secondary {
    background: white;
    color: #6b7280;
    border: 1px solid #e5e7eb;
}

.order-action-btn.secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
}

.order-action-btn.danger {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.order-action-btn.danger:hover {
    background: #fecaca;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-state-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
}

.empty-state h3 {
    margin-bottom: 0.75rem;
    color: #1a1a1a;
    font-size: 1.5rem;
}

.empty-state p {
    color: #6b7280;
    margin-bottom: 2rem;
    font-size: 1.05rem;
}

/* Auth Forms */
.auth-form {
    max-width: 420px;
    margin: 0 auto;
}

.auth-input {
    width: 100%;
    padding: 0.95rem 1.15rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.2s ease;
    margin-bottom: 1rem;
}

.auth-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.auth-btn {
    width: 100%;
    padding: 1.05rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

.auth-btn-secondary {
    background: white;
    color: #1a1a1a;
    border: 2px solid #e5e7eb;
}

.auth-btn-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.auth-link {
    text-align: center;
    color: #667eea;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    margin: 1rem 0;
    transition: color 0.2s ease;
}

.auth-link:hover {
    color: #764ba2;
    text-decoration: underline;
}

.auth-divider {
    text-align: center;
    color: #9ca3af;
    margin: 1.5rem 0;
    position: relative;
    font-size: 0.875rem;
}

.auth-divider::before,
.auth-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 42%;
    height: 1px;
    background: #e5e7eb;
}

.auth-divider::before {
    left: 0;
}

.auth-divider::after {
    right: 0;
}

.error-message {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    padding: 0.85rem 1.15rem;
    border-radius: 10px;
    font-size: 0.925rem;
    margin-bottom: 1rem;
    border-left: 4px solid #dc2626;
}

.success-message {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: 0.85rem 1.15rem;
    border-radius: 10px;
    font-size: 0.925rem;
    margin-bottom: 1rem;
    border-left: 4px solid #10b981;
}

/* Order Detail View */
.order-detail {
    background: white;
    border-radius: 14px;
    padding: 2rem;
    border: 2px solid #e5e7eb;
}

.order-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #f3f4f6;
}

.order-detail-items {
    margin-bottom: 2rem;
}

.order-detail-item {
    display: flex;
    gap: 1.25rem;
    padding: 1.25rem;
    background: #f9fafb;
    border-radius: 12px;
    margin-bottom: 1rem;
}

.order-detail-item-img {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    border: 2px solid #e5e7eb;
    flex-shrink: 0;
}

.order-detail-item-info {
    flex: 1;
}

.order-detail-item-name {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1.05rem;
}

.order-detail-item-meta {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.order-detail-item-price {
    font-weight: 700;
    font-size: 1.15rem;
    color: #1a1a1a;
}

.order-summary-totals {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 12px;
    margin-top: 1.5rem;
}

.order-summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.6rem 0;
    font-size: 0.975rem;
    color: #6b7280;
}

.order-summary-row.total {
    border-top: 2px solid #e5e7eb;
    padding-top: 1rem;
    margin-top: 0.75rem;
    font-weight: 700;
    font-size: 1.25rem;
    color: #1a1a1a;
}
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        Free shipping on orders over $75 | Use code: FIRST10 for 10% off your first order
    </div>

    <!-- Header -->
    <header>
        <nav>
            <div class="logo" onclick="scrollToTop()">CustomThreads</div>
            
   <ul class="nav-links">
    <li><a href="all-shop.html">Shop All</a></li>
    <li><a href="mens.html">Men</a></li>
    <li><a href="womens.html">Women</a></li>
                           <li><a href="saveddesigns.html">Saved Designs</a></li>

       <li><button onclick="showBulkOrders()">Bulk Orders</button></li>
    <li><button onclick="showAbout()">About</button></li>
</ul>

            <div class="nav-actions">
                <button onclick="showAccount()">üë§</button>
           <button onclick="openAdvancedCart()" class="cart-badge">
    üõí
    <span class="cart-count" id="cartCount">0</span>
</button>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-container">
            <div class="hero-content">
                <h1>Premium Custom Printed Apparel</h1>
                <p>Upload your design and we'll print it on high-quality clothing. Professional laser printing technology ensures vibrant colors and lasting durability.</p>
                <div class="hero-buttons">
<button class="btn-primary" onclick="window.location.href='DesignStudio.html'">Upload Your Design</button>
<a href="all-shop.html" class="btn-secondary" style="display: inline-block; text-decoration: none; text-align: center;">Browse Products</a>
                </div>
            </div>
            <div class="hero-images">
                <div class="hero-image">üëï</div>
                <div class="hero-image">üß•</div>
                <div class="hero-image">üëö</div>
                <div class="hero-image">üß¢</div>
            </div>
        </div>
    </section>

    <!-- Trust Section -->
    <section class="trust-section">
        <div class="trust-container">
            <div class="trust-item">
                <div class="trust-icon">üöö</div>
                <h3>Fast Delivery</h3>
                <p>Orders shipped within 2-3 business days</p>
            </div>
            <div class="trust-item">
                <div class="trust-icon">‚ú®</div>
                <h3>Premium Quality</h3>
                <p>Laser printing for exceptional results</p>
            </div>
            <div class="trust-item">
                <div class="trust-icon">üîí</div>
                <h3>Secure Payments</h3>
                <p>Encrypted checkout process</p>
            </div>
            <div class="trust-item">
                <div class="trust-icon">‚Ü©Ô∏è</div>
                <h3>Easy Returns</h3>
                <p>30-day hassle-free returns</p>
            </div>
        </div>
    </section>

    <!-- Categories -->
   

    <!-- Featured Products -->
   
    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-brand">
                <h3>CustomThreads</h3>
                <p>Premium custom printed apparel using advanced laser printing technology. Quality products, fast delivery, exceptional service.</p>
            </div>

            <div class="footer-section">
                <h4>Shop</h4>
                <button onclick="showShop('men')">Men's Apparel</button><br>
                <button onclick="showShop('women')">Women's Apparel</button><br>
                <button onclick="showShop('kids')">Kids' Apparel</button><br>
                <button onclick="showShop('accessories')">Accessories</button><br>
                <button onclick="showBulkOrders()">Bulk Orders</button>
            </div>

            <div class="footer-section">
                <h4>Support</h4>
                <button onclick="showFAQ()">FAQ</button><br>
                <button onclick="showShippingInfo()">Shipping Info</button><br>
                <button onclick="showReturns()">Returns</button><br>
                <button onclick="showSizeGuide()">Size Guide</button><br>
                <button onclick="showContact()">Contact Us</button>
            </div>

            <div class="footer-section">
                <h4>Company</h4>
                <button onclick="showAbout()">About Us</button><br>
                <button onclick="showTechnology()">Our Technology</button><br>
                <button onclick="showBlog()">Blog</button>
            </div>

            <div class="footer-section">
                <h4>Legal</h4>
                <button onclick="showPrivacy()">Privacy Policy</button><br>
                <button onclick="showTerms()">Terms of Service</button>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2025 CustomThreads. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modals -->
    
    <!-- Cart Modal -->
    <div id="cartModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('cartModal')">√ó</button>
            <h2>Shopping Cart</h2>
            <div id="cartContent"></div>
        </div>
    </div>

    <!-- Product Detail Modal -->



    <!-- Account Modal -->
    <div id="accountModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('accountModal')">√ó</button>
            <div id="accountContent"></div>
        </div>
    </div>

 

    <!-- Generic Content Modal -->
    <div id="contentModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('contentModal')">√ó</button>
            <div id="genericContent"></div>
        </div>
    </div>

<script>
// ===== SHARED AUTHENTICATION MODULE =====
const Auth = {
    storageKey: 'ct_auth_users',
    currentUserKey: 'ct_current_user',
    
    getUsers() {
        try {
            return JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        } catch(e) {
            return [];
        }
    },
    
    saveUsers(users) {
        localStorage.setItem(this.storageKey, JSON.stringify(users));
    },
    
    getCurrentUser() {
        try {
            return JSON.parse(localStorage.getItem(this.currentUserKey) || 'null');
        } catch(e) {
            return null;
        }
    },
    
    setCurrentUser(user) {
        if (user) {
            localStorage.setItem(this.currentUserKey, JSON.stringify(user));
        } else {
            localStorage.removeItem(this.currentUserKey);
        }
    },
    
    signUp(email, password, firstName, lastName) {
        const users = this.getUsers();
        
        if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) {
            return { success: false, message: 'Email already registered' };
        }
        
        const newUser = {
            id: 'user_' + Date.now(),
            email: email.toLowerCase(),
            password: password,
            firstName,
            lastName,
            createdAt: new Date().toISOString(),
            cart: [],
            orders: [],
            savedDesigns: []
        };
        
        users.push(newUser);
        this.saveUsers(users);
        this.setCurrentUser(newUser);
        
        return { success: true, user: newUser };
    },
    
    signIn(email, password) {
        const users = this.getUsers();
        const user = users.find(u => 
            u.email.toLowerCase() === email.toLowerCase() && 
            u.password === password
        );
        
        if (user) {
            this.setCurrentUser(user);
            return { success: true, user };
        }
        
        return { success: false, message: 'Invalid email or password' };
    },
    
    signOut() {
        this.setCurrentUser(null);
    },
    
    emailExists(email) {
        const users = this.getUsers();
        return users.find(u => u.email.toLowerCase() === email.toLowerCase());
    },
    
    resetPassword(email, newPassword) {
        const users = this.getUsers();
        const userIndex = users.findIndex(u => u.email.toLowerCase() === email.toLowerCase());
        
        if (userIndex !== -1) {
            users[userIndex].password = newPassword;
            this.saveUsers(users);
            return { success: true };
        }
        
        return { success: false, message: 'Email not found' };
    },
    
    updateUser(updates) {
        const currentUser = this.getCurrentUser();
        if (!currentUser) return { success: false, message: 'Not logged in' };
        
        const users = this.getUsers();
        const userIndex = users.findIndex(u => u.id === currentUser.id);
        
        if (userIndex !== -1) {
            users[userIndex] = { ...users[userIndex], ...updates };
            this.saveUsers(users);
            this.setCurrentUser(users[userIndex]);
            return { success: true, user: users[userIndex] };
        }
        
        return { success: false, message: 'User not found' };
    }
};

// ===== APP STATE =====
let userAccount = Auth.getCurrentUser();
let savedDesigns = [];
let orderHistory = [];

// PayPal and Stripe Configuration
const PAYPAL_EMAIL = 'payments@customthreads.com';

// Product Database


// ===== UTILITY FUNCTIONS =====
function updateCartCount() {
    userAccount = Auth.getCurrentUser();
    const cart = userAccount ? (userAccount.cart || []) : [];
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cartCount').textContent = totalItems;
}


// Initialize on load
updateCartCount();
loadFeaturedProducts();

// ... REST OF YOUR FUNCTIONS (closeModal, openModal, showMessage, etc.)

// ... REST OF YOUR FUNCTIONS (closeModal, openModal, showMessage, etc.)

// ===== UTILITY FUNCTIONS =====
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateCartCount() {
    try {
        const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
        const totalItems = cart.reduce((sum, item) => sum + (item.quantity || item.qty || 1), 0);
        const countEl = document.getElementById('cartCount');
        if (countEl) countEl.textContent = totalItems;
    } catch(e) {
        const countEl = document.getElementById('cartCount');
        if (countEl) countEl.textContent = '0';
    }
}

// Listen for cart changes from other tabs/pages
window.addEventListener('storage', function(e) {
    if (e.key === 'ct_cart_v1') {
        updateCartCount();
    }
});

// Update count every second as fallback
setInterval(updateCartCount, 1000);

    
function showMessage(text, type = 'success') {
    const message = document.createElement('div');
    message.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 20000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    message.textContent = text;
    document.body.appendChild(message);
    
    setTimeout(() => message.remove(), 3000);
}

// ===== PRODUCT FUNCTIONS =====
function loadFeaturedProducts() {
    const featured = allProducts.slice(0, 4);
    document.getElementById('featuredProducts').innerHTML = featured.map(product => createProductCard(product)).join('');
}





// ===== CART FUNCTIONS =====
function showCart() {
    const { custom, standard } = CartManager.getItemsByType();
    const cartContent = document.getElementById('cartContent');
    
    if (custom.length === 0 && standard.length === 0) {
        cartContent.innerHTML = `
            <div class="empty-cart">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üõí</div>
                <h3>Your cart is empty</h3>
                <p>Start shopping to add items to your cart</p>
                <button class="btn-primary" style="margin-top: 1rem;" onclick="closeModal('cartModal'); showShop();">Browse Products</button>
            </div>
        `;
        openModal('cartModal');
        return;
    }
    
    let html = '';
    
    // Custom Designs Section
    if (custom.length > 0) {
        html += `
            <h3 style="margin-bottom: 1rem; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">
                üé® Custom Designs
            </h3>
            <div class="cart-items">
        `;
        
        custom.forEach(item => {
            const thumbnail = item.customDesign?.thumbnails ? 
                (item.customDesign.thumbnails.front || Object.values(item.customDesign.thumbnails)[0]) : 
                '';
            const activeSides = item.customDesign?.activeSides?.join(', ') || 'front';
            
            html += `
                <div class="cart-item">
                    <div class="cart-item-image" style="${thumbnail ? `background-image: url('${thumbnail}'); background-size: cover; background-position: center;` : ''}">
                        ${!thumbnail ? item.icon : ''}
                    </div>
                    <div class="cart-item-details">
                        <h4>${item.name}</h4>
                        <p style="font-size: 0.85rem; color: #6b7280;">Size: ${item.size || 'Not specified'} | Color: ${item.color || 'Not specified'}</p>
                        <p style="font-size: 0.85rem; color: #6b7280;">Sides: ${activeSides}</p>
                        <p style="font-size: 0.85rem; color: #6b7280;">Product: ${item.customDesign?.productType || 'T-Shirt'}</p>
                        <div class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <input type="number" value="${item.quantity}" min="1" max="99" 
                               style="width: 60px; padding: 0.25rem; border: 1px solid #e5e7eb; border-radius: 4px;"
                               onchange="CartManager.updateQuantity('${item.id}', this.value); showCart();">
                        <button onclick="CartManager.removeItem('${item.id}'); showCart();" 
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Standard Products Section
    if (standard.length > 0) {
        html += `
            <h3 style="margin: ${custom.length > 0 ? '2rem' : '0'} 0 1rem; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">
                üëï Standard Products
            </h3>
            <div class="cart-items">
        `;
        
        standard.forEach(item => {
            html += `
                <div class="cart-item">
                    <div class="cart-item-image">
                        ${item.icon}
                    </div>
                    <div class="cart-item-details">
                        <h4>${item.name}</h4>
                        <p>Size: ${item.size} | Color: ${item.color}</p>
                        <div class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <input type="number" value="${item.quantity}" min="1" max="99" 
                               style="width: 60px; padding: 0.25rem; border: 1px solid #e5e7eb; border-radius: 4px;"
                               onchange="CartManager.updateQuantity('${item.id}', this.value); showCart();">
                        <button onclick="CartManager.removeItem('${item.id}'); showCart();" 
                                style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Cart Total
    const total = CartManager.getTotal();
    const shipping = total > 75 ? 0 : 1.00;
    const finalTotal = total + shipping;
    
    html += `
        <div class="cart-total">
            <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #6b7280;">
                    <span>Subtotal:</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #6b7280;">
                    <span>Shipping:</span>
                    <span>${shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2)}</span>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid #e5e7eb;">
                <span class="cart-total-label">Total:</span>
                <span class="cart-total-amount">$${finalTotal.toFixed(2)}</span>
            </div>
        </div>
        
        <button class="btn-primary" style="width: 100%; margin-top: 1rem;" onclick="proceedToCheckout()">
            Proceed to Checkout
        </button>
    `;
    
    cartContent.innerHTML = html;
    openModal('cartModal');
}
    
function addToCart(item) {
    if (!userAccount) {
        showMessage('Please sign in to add items to cart', 'error');
        showAccount();
        return;
        
    }

      if (!userAccount.cart) userAccount.cart = [];
    userAccount.cart.push(item);
    Auth.updateUser({ cart: userAccount.cart });
    updateCartCount();
    showMessage('‚úì Added to cart!');
}
    
    
function removeFromCart(index) {
    if (!userAccount) return;
    
    userAccount.cart.splice(index, 1);
    Auth.updateUser({ cart: userAccount.cart });
    updateCartCount();
    showCart();
}


    
// ===== CHECKOUT & PAYMENT =====

function showOrderConfirmation(orderId) {
    document.getElementById('genericContent').innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">‚úÖ</div>
            <h2 style="margin-bottom: 1rem;">Order Placed Successfully!</h2>
            <p style="color: #6b7280; margin-bottom: 0.5rem;">Your order <strong>${orderId}</strong> has been confirmed.</p>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">We'll send you a confirmation email shortly with tracking information.</p>
            <button class="btn-primary" onclick="closeModal('contentModal')">Continue Shopping</button>
            <button class="btn-secondary" style="margin-left: 0.5rem;" onclick="closeModal('contentModal'); showAccount()">View Orders</button>
        </div>
    `;
}

// ===== SHOP & FILTERING =====




// ===== DESIGN STUDIO =====
function showDesignStudio(productId = null) {
    const product = productId ? allProducts.find(p => p.id === productId) : allProducts[0];
    
    document.getElementById('designStudioContent').innerHTML = `
        <div class="design-studio">
            <div>
                <h3 style="margin-bottom: 1rem;">Design Preview</h3>
                <div class="design-canvas" id="designCanvas">
                    <div style="text-align: center; color: #9ca3af;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üé®</div>
                        <p>Your design will appear here</p>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn-secondary" style="padding: 0.6rem 1.2rem;" onclick="clearDesign()">Clear</button>
                    <button class="btn-secondary" style="padding: 0.6rem 1.2rem;" onclick="saveDesign()">Save Design</button>
                    <button class="btn-primary" style="padding: 0.6rem 1.2rem; flex: 1;" onclick="addDesignToCart()">Add to Cart</button>
                </div>
            
            <div class="design-controls">
                <div class="control-group">
                    <label>Product</label>
                    <select id="designProduct">
                        ${allProducts.map(p => `<option value="${p.id}" ${p.id === product.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Upload Design Image</label>
                    <input type="file" accept="image/*" onchange="previewDesignImage(event)">
                    <small style="color: #6b7280; display: block; margin-top: 0.3rem;">PNG, JPG, or PDF. Min 300 DPI recommended</small>
                </div>
                
                <div class="control-group">
                    <label>Add Text</label>
                    <input type="text" id="designText" placeholder="Enter your text" oninput="updateDesignText()">
                </div>
                
                <div class="control-group">
                    <label>Text Color</label>
                    <input type="color" id="textColor" value="#000000" onchange="updateDesignText()">
                </div>
                
                <div class="control-group">
                    <label>Font Size</label>
                    <input type="range" min="12" max="72" value="24" id="fontSize" oninput="updateDesignText()">
                </div>
                
                <div class="control-group">
                    <label>Design Placement</label>
                    <select id="designPlacement">
                        <option>Front Center</option>
                        <option>Back Center</option>
                        <option>Front Left Chest</option>
                        <option>Full Front Print</option>
                        <option>Full Back Print</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Product Color</label>
                    <select id="designColor">
                        <option>Black</option>
                        <option>White</option>
                        <option>Navy</option>
                        <option>Grey</option>
                        <option>Red</option>
                        <option>Blue</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Size</label>
                    <select id="designSize">
                        <option>M</option>
                        <option>XS</option>
                        <option>S</option>
                        <option>L</option>
                        <option>XL</option>
                        <option>2XL</option>
                        <option>3XL</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    openModal('designModal');
}

function previewDesignImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('designCanvas').innerHTML = `
                <img src="${e.target.result}" style="max-width: 80%; max-height: 80%; border-radius: 8px;">
            `;
        };
        reader.readAsDataURL(file);
    }
}

function updateDesignText() {
    const text = document.getElementById('designText').value;
    const color = document.getElementById('textColor').value;
    const fontSize = document.getElementById('fontSize').value;
    
    if (text) {
        document.getElementById('designCanvas').innerHTML = `
            <div style="font-size: ${fontSize}px; color: ${color}; font-weight: 700; text-align: center; padding: 2rem;">
                ${text}
            </div>
        `;
    }
}

function clearDesign() {
    document.getElementById('designCanvas').innerHTML = `
        <div style="text-align: center; color: #9ca3af;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üé®</div>
            <p>Your design will appear here</p>
        </div>
    `;
    document.getElementById('designText').value = '';
}

function saveDesign() {
    const designData = {
        id: Date.now(),
        productId: document.getElementById('designProduct').value,
        text: document.getElementById('designText').value,
        color: document.getElementById('textColor').value,
        fontSize: document.getElementById('fontSize').value,
        placement: document.getElementById('designPlacement').value,
        date: new Date().toISOString()
    };
    
    savedDesigns.push(designData);
    showMessage('Design saved successfully!');
}

function addDesignToCart() {
    const productId = parseInt(document.getElementById('designProduct').value);
    const product = allProducts.find(p => p.id === productId);
    const size = document.getElementById('designSize').value;
    const color = document.getElementById('designColor').value;
    
    addToCart({
        productId: product.id,
        name: product.name + ' (Custom Design)',
        price: product.price + 10,
        icon: 'üé®',
        size: size,
        color: color,
        quantity: 1,
        isCustom: true
    });
    
    closeModal('designModal');
}

// ===== ACCOUNT FUNCTIONS =




function showSignUp() {
    document.getElementById('accountContent').innerHTML = `
        <h2>Create Account</h2>
        <form onsubmit="createAccount(event)">
            <div class="form-row">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" name="firstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" name="lastName" required>
                </div>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" required minlength="8">
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-bottom: 1rem;">Create Account</button>
        </form>
        <button class="btn-secondary" style="width: 100%;" onclick="showAccount()">Back to Sign In</button>
    `;
}

function signIn(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const password = formData.get('password');
    
    const result = Auth.signIn(email, password);
    
    if (result.success) {
        userAccount = result.user;
        showMessage('Signed in successfully!');
        showAccount();
    } else {
        showMessage(result.message, 'error');
    }
}

function createAccount(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const firstName = formData.get('firstName');
    const lastName = formData.get('lastName');
    const email = formData.get('email');
    const password = formData.get('password');
    
    if (password.length < 8) {
        showMessage('Password must be at least 8 characters', 'error');
        return;
    }
    
    const result = Auth.signUp(email, password, firstName, lastName);
    
    if (result.success) {
        userAccount = result.user;
        showMessage('Account created successfully!');
        showAccount();
    } else {
        showMessage(result.message, 'error');
    }
}

function signOut() {
    Auth.signOut();
    userAccount = null;
    closeModal('accountModal');
    showMessage('Signed out successfully');
}

        function showForgotPassword() {
    document.getElementById('accountContent').innerHTML = `
        <h2>Forgot Password</h2>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">Enter your email address and we'll help you reset your password.</p>
        
        <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" name="email" id="resetEmail" required>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-bottom: 1rem;">Continue</button>
        </form>
        
        <button class="btn-secondary" style="width: 100%;" onclick="showAccount()">Back to Sign In</button>
    `;
}

function handleForgotPassword(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const email = formData.get('email');
    
    const userExists = Auth.emailExists(email);
    
    if (userExists) {
        showResetPasswordForm(email);
    } else {
        showMessage('No account found with this email address', 'error');
    }
}

function showResetPasswordForm(email) {
    document.getElementById('accountContent').innerHTML = `
        <h2>Reset Password</h2>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">Enter your new password for <strong>${email}</strong></p>
        
        <form onsubmit="handlePasswordReset(event, '${email}')">
            <div class="form-group">
                <label>New Password</label>
                <input type="password" name="password" id="newPassword" required minlength="8">
                <small style="color: #6b7280;">Must be at least 8 characters</small>
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" name="confirmPassword" id="confirmPassword" required minlength="8">
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-bottom: 1rem;">Reset Password</button>
        </form>
        
        <button class="btn-secondary" style="width: 100%;" onclick="showAccount()">Cancel</button>
    `;
}

function handlePasswordReset(e, email) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');
    
    if (password !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showMessage('Password must be at least 8 characters', 'error');
        return;
    }
    
    const result = Auth.resetPassword(email, password);
    
    if (result.success) {
        showMessage('Password reset successful! Please sign in with your new password.');
        showAccount();
    } else {
        showMessage(result.message, 'error');
    }
}

function showOrders() {
    // Change the filename below if your orders page has a different name
    window.location.href = 'Orders.html';
}

function showSavedDesigns() {
    // If you have a dedicated SavedDesigns page, change the filename.
    window.location.href = 'saveddesigns.html';
}
    
  



function showProfile() {
    document.getElementById('accountContent').innerHTML = `
        <h2>Profile Settings</h2>
        <form onsubmit="updateProfile(event)">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" value="${userAccount.name}" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" value="${userAccount.email}" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" name="phone" value="${userAccount.phone || ''}">
            </div>
            <button type="submit" class="btn-primary" style="width: 100%;">Save Changes</button>
        </form>
    `;
}

function updateProfile(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    userAccount.name = formData.get('name');
    userAccount.email = formData.get('email');
    userAccount.phone = formData.get('phone');
    showMessage('Profile updated successfully!');
    showAccount();
}

// ===== SEARCH =====
function showSearch() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Search Products</h2>
        <form onsubmit="performSearch(event)" style="margin-bottom: 2rem;">
            <div class="form-group">
                <input type="text" id="searchInput" placeholder="Search for products..." style="font-size: 1.1rem; padding: 1rem;">
            </div>
            <button type="submit" class="btn-primary" style="width: 100%;">Search</button>
        </form>
        <div id="searchResults"></div>
    `;
    openModal('contentModal');
    document.getElementById('searchInput').focus();
}

function performSearch(e) {
    e.preventDefault();
    const query = document.getElementById('searchInput').value.toLowerCase();
    const results = allProducts.filter(p => 
        p.name.toLowerCase().includes(query) || 
        p.category.toLowerCase().includes(query)
    );
    
    document.getElementById('searchResults').innerHTML = `
        <h3>Search Results for "${query}"</h3>
        <p style="color: #6b7280;">Found ${results.length} product(s)</p>
        <div class="product-grid" style="margin-top: 1.5rem;">
            ${results.length > 0 ? results.map(product => createProductCard(product)).join('') : '<p style="grid-column: 1/-1; text-align: center; color: #6b7280;">No products found</p>'}
        </div>
    `;
}

// ===== INFORMATION PAGES =====
function showAbout() {
    document.getElementById('genericContent').innerHTML = `
        <h2>About CustomThreads</h2>
        <p style="line-height: 1.8; color: #4a5568; margin-bottom: 1.5rem;">
            CustomThreads was founded in 2020 with a simple mission: to make premium custom apparel accessible to everyone. We believe that everyone deserves to wear clothing that truly represents their unique style and personality.
        </p>
        <p style="line-height: 1.8; color: #4a5568; margin-bottom: 1.5rem;">
            Our state-of-the-art laser printing technology ensures that your designs come to life with exceptional clarity, vibrant colors, and lasting durability. Unlike traditional screen printing, our laser printing process allows for intricate details and unlimited color options.
        </p>
        <h3 style="margin: 2rem 0 1rem;">Our Values</h3>
        <ul style="color: #4a5568; line-height: 1.8; padding-left: 1.5rem;">
            <li><strong>Quality First:</strong> We use only premium materials and advanced printing technology</li>
            <li><strong>Customer Satisfaction:</strong> Your happiness is our priority</li>
            <li><strong>Sustainability:</strong> Eco-friendly materials and responsible production</li>
            <li><strong>Innovation:</strong> Constantly improving our technology and processes</li>
        </ul>
    `;
    openModal('contentModal');
}

function showTechnology() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Our Printing Technology</h2>
        <p style="line-height: 1.8; color: #4a5568; margin-bottom: 1.5rem;">
            CustomThreads uses cutting-edge laser printing technology that sets us apart from traditional printing methods. Our process delivers superior results with unmatched precision and durability.
        </p>
        <h3 style="margin: 2rem 0 1rem;">Why Laser Printing?</h3>
        <ul style="color: #4a5568; line-height: 1.8; padding-left: 1.5rem; margin-bottom: 1.5rem;">
            <li>Ultra-high resolution up to 1200 DPI</li>
            <li>Unlimited color options without additional cost</li>
            <li>Soft feel - no thick, heavy print layer</li>
            <li>Excellent wash durability - won't crack or fade</li>
            <li>Environmentally friendly - no water waste</li>
            <li>Fast production time - no setup or drying needed</li>
        </ul>
        <p style="line-height: 1.8; color: #4a5568;">
            Each garment is carefully inspected before shipping to ensure it meets our high standards. Your satisfaction is guaranteed.
        </p>
    `;
    openModal('contentModal');
}

function showFAQ() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Frequently Asked Questions</h2>
        
        <div style="margin-top: 1.5rem;">
            <h3 style="margin-bottom: 0.5rem;">How long does shipping take?</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">Orders are typically processed within 2-3 business days and shipped via standard shipping (5-7 business days). Express shipping options are available at checkout.</p>
            
            <h3 style="margin-bottom: 0.5rem;">What file formats do you accept?</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">We accept PNG, JPG, PDF, and SVG files. For best results, we recommend high-resolution images (300 DPI or higher).</p>
            
            <h3 style="margin-bottom: 0.5rem;">Can I return custom printed items?</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">We offer a 30-day satisfaction guarantee. If you're not happy with your custom item, contact us for a return or replacement.</p>
            
            <h3 style="margin-bottom: 0.5rem;">How do I care for my custom printed apparel?</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">Machine wash cold, inside out. Tumble dry low or hang dry. Do not iron directly on the print. Our laser prints are very durable and should last the lifetime of the garment.</p>
            
            <h3 style="margin-bottom: 0.5rem;">Do you offer bulk discounts?</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">Yes! We offer special pricing for orders of 10+ items. Contact us for a custom quote.</p>
        </div>
    `;
    openModal('contentModal');
}

function showShippingInfo() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Shipping Information</h2>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Processing Time</h3>
        <p style="color: #6b7280; margin-bottom: 1rem;">All orders are processed within 2-3 business days. Orders are not shipped or delivered on weekends or holidays.</p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Shipping Rates</h3>
        <ul style="color: #6b7280; line-height: 1.8; padding-left: 1.5rem; margin-bottom: 1rem;">
            <li>Standard Shipping (5-7 business days): $9.99</li>
            <li>Express Shipping (2-3 business days): $19.99</li>
            <li>Overnight Shipping (1 business day): $39.99</li>
            <li><strong>FREE SHIPPING on orders over $75!</strong></li>
        </ul>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">International Shipping</h3>
        <p style="color: #6b7280; margin-bottom: 1rem;">We ship worldwide! International shipping rates are calculated at checkout based on destination and weight.</p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Order Tracking</h3>
        <p style="color: #6b7280;">Once your order ships, you'll receive a tracking number via email. You can track your package anytime in your account.</p>
    `;
    openModal('contentModal');
}

function showReturns() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Returns & Exchanges</h2>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">30-Day Satisfaction Guarantee</h3>
        <p style="color: #6b7280; margin-bottom: 1rem;">We want you to love your custom apparel! If you're not completely satisfied, you can return or exchange your item within 30 days of delivery.</p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Return Process</h3>
        <ol style="color: #6b7280; line-height: 1.8; padding-left: 1.5rem; margin-bottom: 1rem;">
            <li>Contact our support team to initiate a return</li>
            <li>Pack your item securely with the original tags</li>
            <li>Ship the item back using the prepaid label we provide</li>
            <li>Receive your refund within 5-7 business days</li>
        </ol>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Exchanges</h3>
        <p style="color: #6b7280; margin-bottom: 1rem;">Need a different size or color? Exchanges are easy! Just let us know what you'd like instead, and we'll send it right away.</p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Custom Orders</h3>
        <p style="color: #6b7280;">Custom printed items can be returned if there's a printing error or defect. We'll reprint your order or issue a full refund.</p>
    `;
    openModal('contentModal');
}

function showSizeGuide() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Size Guide</h2>
        
        <h3 style="margin: 1.5rem 0 1rem;">Men's T-Shirts & Hoodies</h3>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
            <tr style="background: #f9fafb;">
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb; text-align: left;">Size</th>
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb;">Chest (inches)</th>
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb;">Length (inches)</th>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">XS</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">34-36</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">27</td>
            </tr>
            <tr style="background: #f9fafb;">
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">S</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">36-38</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">28</td>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">M</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">38-40</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">29</td>
            </tr>
            <tr style="background: #f9fafb;">
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">L</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">40-42</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">30</td>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">XL</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">42-44</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">31</td>
            </tr>
        </table>

        <h3 style="margin: 1.5rem 0 1rem;">Women's Tanks & Tees</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: #f9fafb;">
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb; text-align: left;">Size</th>
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb;">Bust (inches)</th>
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb;">Length (inches)</th>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">XS</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">30-32</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">24</td>
            </tr>
            <tr style="background: #f9fafb;">
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">S</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">32-34</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">25</td>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">M</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">36-38</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">26</td>
            </tr>
            <tr style="background: #f9fafb;">
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">L</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">40-42</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">27</td>
            </tr>
        </table>
    `;
    openModal('contentModal');
}

function showContact() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Contact Us</h2>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">Have questions? We'd love to hear from you! Fill out the form below and we'll get back to you within 24 hours.</p>
        
        <form onsubmit="submitContact(event)">
            <div class="form-row">
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Email *</label>
                <input type="email" required>
            </div>
            
            <div class="form-group">
                <label>Subject *</label>
                <select required>
                    <option value="">Select a subject</option>
                    <option>Order Question</option>
                    <option>Design Help</option>
                    <option>Bulk Order Inquiry</option>
                    <option>Technical Support</option>
                    <option>Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Message *</label>
                <textarea rows="6" required></textarea>
            </div>
            
            <button type="submit" class="btn-primary" style="width: 100%;">Send Message</button>
        </form>
        
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
            <h3 style="margin-bottom: 1rem;">Other Ways to Reach Us</h3>
            <p style="color: #6b7280; margin-bottom: 0.5rem;">üìß Email: support@customthreads.com</p>
            <p style="color: #6b7280; margin-bottom: 0.5rem;">üìû Phone: 1-800-CUSTOM-1</p>
            <p style="color: #6b7280;">üí¨ Live Chat: Available Mon-Fri 9am-6pm EST</p>
        </div>
    `;
    openModal('contentModal');
}

function submitContact(e) {
    e.preventDefault();
    showMessage('Message sent! We\'ll get back to you within 24 hours.');
    closeModal('contentModal');
}

function showBulkOrders() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Bulk Orders</h2>
        <p style="line-height: 1.8; color: #4a5568; margin-bottom: 1.5rem;">
            Need custom apparel for your team, event, or business? We offer special pricing for bulk orders of 10+ items. Perfect for:
        </p>
        <ul style="color: #4a5568; line-height: 1.8; padding-left: 1.5rem; margin-bottom: 1.5rem;">
            <li>Corporate events and team building</li>
            <li>Sports teams and leagues</li>
            <li>Schools and universities</li>
            <li>Fundraisers and charity events</li>
            <li>Weddings and family reunions</li>
            <li>Promotional merchandise</li>
        </ul>
        
        <h3 style="margin: 2rem 0 1rem;">Bulk Pricing</h3>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
            <tr style="background: #f9fafb;">
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb; text-align: left;">Quantity</th>
                <th style="padding: 0.8rem; border: 1px solid #e5e7eb;">Discount</th>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">10-24 items</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">10% off</td>
            </tr>
            <tr style="background: #f9fafb;">
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">25-49 items</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">15% off</td>
            </tr>
            <tr>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">50-99 items</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">20% off</td>
            </tr>
            <tr style="background: #f9fafb;">
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">100+ items</td>
                <td style="padding: 0.8rem; border: 1px solid #e5e7eb;">Contact for quote</td>
            </tr>
        </table>
        
        <button class="btn-primary" style="width: 100%;" onclick="showContact()">Request Bulk Quote</button>
    `;
    openModal('contentModal');
}

function showBlog() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Blog</h2>
        <p style="color: #6b7280; margin-bottom: 2rem;">Tips, trends, and inspiration for custom apparel</p>
        
        <div style="display: grid; gap: 1.5rem;">
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer;" onclick="showMessage('Blog post coming soon!')">
                <h3>10 Design Tips for Perfect Custom T-Shirts</h3>
                <p style="color: #6b7280; margin: 0.5rem 0;">Learn the best practices for creating eye-catching designs that print beautifully.</p>
                <small style="color: #9ca3af;">Posted 2 days ago</small>
            </div>
            
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer;" onclick="showMessage('Blog post coming soon!')">
                <h3>How to Care for Your Custom Printed Apparel</h3>
// (continuing from showBlog function)
                <p style="color: #6b7280; margin: 0.5rem 0;">Keep your custom designs looking fresh with these washing and care tips.</p>
                <small style="color: #9ca3af;">Posted 1 week ago</small>
            </div>
            
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; cursor: pointer;" onclick="showMessage('Blog post coming soon!')">
                <h3>Custom Apparel Trends for 2025</h3>
                <p style="color: #6b7280; margin: 0.5rem 0;">What's hot in custom printing this year? Discover the latest trends.</p>
                <small style="color: #9ca3af;">Posted 2 weeks ago</small>
            </div>
        </div>
    `;
    openModal('contentModal');
}

function showPrivacy() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Privacy Policy</h2>
        <p style="color: #6b7280; margin-bottom: 1rem;"><em>Last updated: January 2025</em></p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Information We Collect</h3>
        <p style="color: #6b7280; line-height: 1.8; margin-bottom: 1rem;">
            We collect information you provide directly to us, such as when you create an account, place an order, or contact customer service. This includes your name, email address, shipping address, and payment information.
        </p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">How We Use Your Information</h3>
        <p style="color: #6b7280; line-height: 1.8; margin-bottom: 1rem;">
            We use the information we collect to process your orders, communicate with you, improve our services, and provide customer support.
        </p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Data Security</h3>
        <p style="color: #6b7280; line-height: 1.8;">
            We take reasonable measures to protect your personal information from unauthorized access, use, or disclosure. All data is stored securely and encrypted.
        </p>
    `;
    openModal('contentModal');
}

function showTerms() {
    document.getElementById('genericContent').innerHTML = `
        <h2>Terms of Service</h2>
        <p style="color: #6b7280; margin-bottom: 1rem;"><em>Last updated: January 2025</em></p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Acceptance of Terms</h3>
        <p style="color: #6b7280; line-height: 1.8; margin-bottom: 1rem;">
            By accessing and using CustomThreads, you accept and agree to be bound by these terms and conditions.
        </p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Design Copyright</h3>
        <p style="color: #6b7280; line-height: 1.8; margin-bottom: 1rem;">
            You are responsible for ensuring you have the rights to any designs you upload. We reserve the right to refuse any order containing copyrighted or trademarked material without proper authorization.
        </p>
        
        <h3 style="margin: 1.5rem 0 0.5rem;">Order Modifications</h3>
        <p style="color: #6b7280; line-height: 1.8;">
            Once an order is placed and in production, modifications may not be possible. Please review your order carefully before submitting.
        </p>
    `;
    openModal('contentModal');
}

// ===== EVENT LISTENERS =====

// Close modals when clicking outside
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});

// Check for payment success/cancelled in URL
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    
    if (paymentStatus === 'success') {
        showMessage('Payment successful! Your order has been placed.');
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (paymentStatus === 'cancelled') {
        showMessage('Payment was cancelled.', 'error');
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}); 


        (function(){
  // 1) Ensure #DesignStudio section exists
  const designSection = document.getElementById('DesignStudio');
  if (!designSection) {
    console.warn('DesignStudio section not found. The enhancer needs a #DesignStudio section in the page.');
    return;
  }

  // 2) If #design-canvas not present, create a minimal container in a sensible place
  if (!document.getElementById('design-canvas')) {
    // Try to insert into a likely column in the DesignStudio layout
    // Find a place near the "Canvas" area ‚Äî prefer an existing element with id 'canvas-elements' or fallback to end of section
    const beforeEl = designSection.querySelector('#canvas-elements') || designSection.querySelector('.lg\\:col-span-2') || null;
    const container = document.createElement('div');
    container.id = 'design-canvas';
    container.className = 'relative';
    container.style.width = '500px';
    container.style.height = '600px';
    container.style.background = 'transparent';
    container.style.margin = '0 auto';
    container.style.touchAction = 'none';
    // if we found a target, insert after it; otherwise append
    if (beforeEl && beforeEl.parentElement) {
      beforeEl.parentElement.insertBefore(container, beforeEl);
    } else {
      designSection.appendChild(container);
    }
    console.log('Inserted #design-canvas automatically into #DesignStudio.');
  } else {
    // existing container found
    const existing = document.getElementById('design-canvas');
    // strip inner HTML so enhancer can populate it cleanly
    existing.innerHTML = '';
    existing.style.touchAction = 'none';
    console.log('#design-canvas found ‚Äî cleared inner content for enhancer.');
  }

  /* ---------- Now the Enhancer: front/back 2-sided designer ---------- */
  const canvasRoot = document.getElementById('design-canvas');

  // small guard
  if (!canvasRoot) { console.error('design-canvas could not be created.'); return; }

  // if the enhancer already initialized (avoid double-init), bail
  if (canvasRoot.dataset.ctEnhancer === '1') {
    console.log('DesignStudio enhancer already initialized.');
    return;
  }
  canvasRoot.dataset.ctEnhancer = '1';

  // Utilities
  const uid = (p='el') => `${p}-${Date.now()}-${Math.floor(Math.random()*9000+1000)}`;
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

  // State
  const studio = {
    sides: { front: [], back: [] },
    activeSide: 'front',
    selectedId: null,
    shirt: { width: 500, height: 600 },
    productContext: null,
    spinning: false
  };

  // Build viewer
  canvasRoot.style.position = 'relative';
  canvasRoot.style.perspective = '1200px';
  canvasRoot.style.overflow = 'visible';

  const viewer = document.createElement('div');
  viewer.className = 'ct-viewer';
  viewer.style.width = '420px';
  viewer.style.height = '520px';
  viewer.style.margin = '0 auto';
  viewer.style.position = 'relative';
  viewer.style.transformStyle = 'preserve-3d';
  viewer.style.transition = 'transform 600ms cubic-bezier(.22,.9,.25,1)';
  viewer.style.cursor = 'grab';
  canvasRoot.appendChild(viewer);

  const shirtHolder = document.createElement('div');
  shirtHolder.style.width = '100%';
  shirtHolder.style.height = '100%';
  shirtHolder.style.position = 'absolute';
  shirtHolder.style.left = '0';
  shirtHolder.style.top = '0';
  shirtHolder.style.transformStyle = 'preserve-3d';
  viewer.appendChild(shirtHolder);

  function makeFace(side){
    const f = document.createElement('div');
    f.className = `shirt-face ${side}`;
    f.style.position = 'absolute';
    f.style.left = '50%';
    f.style.top = '50%';
    f.style.width = '360px';
    f.style.height = '480px';
    f.style.marginLeft = '-180px';
    f.style.marginTop = '-240px';
    f.style.borderRadius = '28px';
    f.style.background = 'linear-gradient(180deg,#ffffff,#f7f7f7)';
    f.style.boxShadow = '0 12px 30px rgba(0,0,0,.12)';
    f.style.display = 'flex';
    f.style.alignItems = 'center';
    f.style.justifyContent = 'center';
    f.style.transformStyle = 'preserve-3d';
    f.style.backfaceVisibility = 'hidden';
    const overlay = document.createElement('div');
    overlay.className = 'design-overlay';
    overlay.style.position = 'absolute';
    overlay.style.left = '50%';
    overlay.style.top = '50%';
    overlay.style.width = '320px';
    overlay.style.height = '420px';
    overlay.style.marginLeft = '-160px';
    overlay.style.marginTop = '-210px';
    overlay.style.pointerEvents = 'auto';
    overlay.style.overflow = 'visible';
    f.appendChild(overlay);
    return { face: f, overlay };
  }

  const front = makeFace('front');
  const back = makeFace('back');
  front.face.style.transform = 'translateZ(1px) rotateY(0deg)';
  back.face.style.transform = 'translateZ(-1px) rotateY(180deg)';
  back.face.style.background = 'linear-gradient(180deg,#f6f6f6,#efefef)';
  shirtHolder.appendChild(front.face);
  shirtHolder.appendChild(back.face);

  // Controls column (simple)
  const controls = document.createElement('div');
  controls.style.position = 'absolute';
  controls.style.right = '8px';
  controls.style.top = '8px';
  controls.style.display = 'flex';
  controls.style.flexDirection = 'column';
  controls.style.gap = '6px';
  canvasRoot.appendChild(controls);

  function mkBtn(label, cb){
    const b = document.createElement('button');
    b.textContent = label;
    b.style.background = 'rgba(0,0,0,.72)';
    b.style.color = '#fff';
    b.style.border = 'none';
    b.style.padding = '6px 10px';
    b.style.borderRadius = '6px';
    b.style.fontSize = '13px';
    b.style.cursor = 'pointer';
    b.onclick = cb;
    return b;
  }

  const btnFront = mkBtn('Front', ()=>showSide('front'));
  const btnBack = mkBtn('Back', ()=>showSide('back'));
  const btnFlip = mkBtn('Flip', ()=>toggleFlip());
  const btnSpin = mkBtn('Spin', ()=>toggleSpin());
  const btnSymbol = mkBtn('Add Symbol', ()=>openSymbolPicker());
  const btnExport = mkBtn('Export PNG', ()=>exportActiveSideAsPNG());
  controls.appendChild(btnFront);
  controls.appendChild(btnBack);
  controls.appendChild(btnFlip);
  controls.appendChild(btnSpin);
  controls.appendChild(btnSymbol);
  controls.appendChild(btnExport);

  // helper message
  const hint = document.createElement('div');
  hint.style.position='absolute';
  hint.style.left='50%';
  hint.style.bottom='8px';
  hint.style.transform='translateX(-50%)';
  hint.style.background='rgba(255,255,255,.9)';
  hint.style.padding='6px 10px';
  hint.style.borderRadius='999px';
  hint.style.fontSize='13px';
  hint.style.color='#333';
  hint.textContent = 'Drag elements ‚Äî use handles to resize/rotate';
  canvasRoot.appendChild(hint);

  // Show side
  function showSide(side){
    studio.activeSide = side;
    if (side==='front') viewer.style.transform = `rotateY(0deg)`; else viewer.style.transform = `rotateY(180deg)`;
    renderActiveOverlay();
  }
  function toggleFlip(){ showSide(studio.activeSide === 'front' ? 'back' : 'front'); }

  // Spin
  let spinTimer = null;
  function toggleSpin(){
    studio.spinning = !studio.spinning;
    if (studio.spinning){
      let deg = 0;
      spinTimer = setInterval(()=>{ deg = (deg + 8) % 360; viewer.style.transform = 'rotateY(' + deg + 'deg)'; }, 40);
    } else {
      clearInterval(spinTimer); spinTimer = null;
      showSide(studio.activeSide);
    }
  }

  /* ---------- Render / Elements ---------- */
  function getActiveArray(){ return studio.sides[studio.activeSide]; }

  function makeNode(el){
    const wrap = document.createElement('div');
    wrap.className = 'dt-el';
    wrap.dataset.id = el.id;
    wrap.style.position = 'absolute';
    wrap.style.left = (el.x||50) + 'px';
    wrap.style.top = (el.y||50) + 'px';
    wrap.style.width = (el.width||150) + 'px';
    wrap.style.height = (el.height||80) + 'px';
    wrap.style.transform = `rotate(${el.rotation||0}deg)`;
    wrap.style.transformOrigin = 'center center';
    wrap.style.cursor = 'grab';
    wrap.style.touchAction = 'none';
    wrap.style.display = 'flex';
    wrap.style.alignItems = 'center';
    wrap.style.justifyContent = 'center';
    wrap.style.userSelect = 'none';
    if (el.type === 'text' || el.type === 'symbol'){
      const t = document.createElement('div');
      t.style.fontSize = (el.fontSize||32) + 'px';
      t.style.color = el.color || '#000';
      t.style.textAlign = 'center';
      t.style.pointerEvents = 'none';
      t.style.whiteSpace = 'pre-wrap';
      t.textContent = el.content || 'Text';
      wrap.appendChild(t);
    } else {
      const img = document.createElement('img');
      img.src = el.url || '';
      img.draggable = false;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      img.style.pointerEvents = 'none';
      wrap.appendChild(img);
    }
    if (studio.selectedId === el.id) wrap.style.outline = '2px solid rgba(59,130,246,.6)';
    else wrap.style.outline = 'none';
    return wrap;
  }

  function renderActiveOverlay(){
    front.overlay.innerHTML = ''; back.overlay.innerHTML = '';
    (studio.sides.front || []).forEach(el => renderElementTo(front.overlay, el));
    (studio.sides.back || []).forEach(el => renderElementTo(back.overlay, el));
  }

  function renderElementTo(overlay, el){
    const node = makeNode(el);
    node.addEventListener('pointerdown', elPointerDown);
    overlay.appendChild(node);
    if (studio.selectedId === el.id && overlay === (studio.activeSide === 'front' ? front.overlay : back.overlay)) {
      attachTransformer(node, el, overlay);
    }
  }

  /* ---------- Drag + select ---------- */
  let drag = null;
  function elPointerDown(e){
    e.stopPropagation();
    const node = e.currentTarget;
    const id = node.dataset.id;
    const all = studio.sides.front.concat(studio.sides.back);
    const el = all.find(x=>x.id===id);
    if (!el) return;
    studio.selectedId = id;
    document.getElementById('element-controls') && document.getElementById('element-controls').classList.remove('hidden');
    renderActiveOverlay();
    node.setPointerCapture(e.pointerId);
    drag = { id, elRef: el, node, startX: e.clientX, startY: e.clientY, origX: el.x, origY: el.y, pointerId: e.pointerId };
    document.addEventListener('pointermove', onDragMove);
    document.addEventListener('pointerup', onDragUp);
    document.addEventListener('pointercancel', onDragUp);
  }
  function onDragMove(e){
    if (!drag || e.pointerId !== drag.pointerId) return;
    e.preventDefault();
    const dx = e.clientX - drag.startX; const dy = e.clientY - drag.startY;
    drag.elRef.x = clamp(Math.round(drag.origX + dx), -1000, 1000);
    drag.elRef.y = clamp(Math.round(drag.origY + dy), -1000, 1000);
    drag.node.style.left = drag.elRef.x + 'px'; drag.node.style.top = drag.elRef.y + 'px';
  }
  function onDragUp(e){
    if (!drag || e.pointerId !== drag.pointerId) return;
    try { drag.node.releasePointerCapture(e.pointerId); } catch(e){}
    document.removeEventListener('pointermove', onDragMove);
    document.removeEventListener('pointerup', onDragUp);
    document.removeEventListener('pointercancel', onDragUp);
    drag = null; renderActiveOverlay();
  }

  front.overlay.addEventListener('pointerdown', (e)=> { if (e.target === front.overlay) { studio.selectedId = null; document.getElementById('element-controls') && document.getElementById('element-controls').classList.add('hidden'); renderActiveOverlay(); } });
  back.overlay.addEventListener('pointerdown', (e)=> { if (e.target === back.overlay) { studio.selectedId = null; document.getElementById('element-controls') && document.getElementById('element-controls').classList.add('hidden'); renderActiveOverlay(); } });

  /* ---------- Transformer (resize & rotate) ---------- */
  let currentTransformer = null;
  function attachTransformer(node, el, overlay){
    // remove old transformer if present
    const old = overlay.querySelector('.transformer'); if (old) old.remove();

    const tf = document.createElement('div'); tf.className='transformer';
    tf.style.position='absolute'; tf.style.left=node.style.left; tf.style.top=node.style.top;
    tf.style.width=node.style.width; tf.style.height=node.style.height; tf.style.transform=node.style.transform;
    tf.style.boxSizing='border-box'; tf.style.border='1px dashed rgba(0,0,0,.35)'; tf.style.pointerEvents='none'; tf.style.zIndex=9999;

    const corners = ['tl','tr','bl','br'];
    corners.forEach(pos => {
      const h = document.createElement('div'); h.className='handle '+pos; h.style.width='12px'; h.style.height='12px'; h.style.borderRadius='3px'; h.style.background='#fff';
      h.style.border='1px solid rgba(0,0,0,.6)'; h.style.position='absolute'; h.style.pointerEvents='auto';
      if (pos==='tl'){ h.style.left='-6px'; h.style.top='-6px'; }
      if (pos==='tr'){ h.style.right='-6px'; h.style.top='-6px'; }
      if (pos==='bl'){ h.style.left='-6px'; h.style.bottom='-6px'; }
      if (pos==='br'){ h.style.right='-6px'; h.style.bottom='-6px'; }
      tf.appendChild(h);
      makeScaleHandle(h, el, overlay, node);
    });
    const rh = document.createElement('div'); rh.className='handle rotate'; rh.style.width='14px'; rh.style.height='14px'; rh.style.borderRadius='50%';
    rh.style.background='#fff'; rh.style.border='1px solid rgba(0,0,0,.6)'; rh.style.position='absolute'; rh.style.left='50%'; rh.style.top='-26px'; rh.style.transform='translateX(-50%)'; rh.style.pointerEvents='auto';
    tf.appendChild(rh); makeRotateHandle(rh, el, overlay, node);
    overlay.appendChild(tf); currentTransformer = { tf, el, node, overlay };
  }

  function makeScaleHandle(handleNode, el, overlay, node){
    let active=false, start=null, startW, startH, startX, startY;
    handleNode.addEventListener('pointerdown', function(e){
      e.stopPropagation(); e.preventDefault(); active=true; handleNode.setPointerCapture(e.pointerId);
      start = { x:e.clientX, y:e.clientY }; startW = el.width||parseInt(node.style.width)||150; startH = el.height||parseInt(node.style.height)||80;
      startX = el.x; startY = el.y;
      document.addEventListener('pointermove', onMove); document.addEventListener('pointerup', onUp);
    });
    function onMove(e){
      if (!active) return; e.preventDefault(); const dx = e.clientX - start.x, dy = e.clientY - start.y;
      const cls = handleNode.className;
      let newW = startW, newH = startH, newX = startX, newY = startY;
      if (cls.includes('br')) { newW = Math.max(20, startW + dx); newH = Math.max(20, startH + dy); }
      if (cls.includes('tr')) { newW = Math.max(20, startW + dx); newH = Math.max(20, startH - dy); newY = startY + dy; }
      if (cls.includes('bl')) { newW = Math.max(20, startW - dx); newH = Math.max(20, startH + dy); newX = startX + dx; }
      if (cls.includes('tl')) { newW = Math.max(20, startW - dx); newH = Math.max(20, startH - dy); newX = startX + dx; newY = startY + dy; }
      el.width = Math.round(newW); el.height = Math.round(newH); el.x = Math.round(newX); el.y = Math.round(newY);
      node.style.width = el.width + 'px'; node.style.height = el.height + 'px'; node.style.left = el.x + 'px'; node.style.top = el.y + 'px';
      if (currentTransformer && currentTransformer.tf){ currentTransformer.tf.style.left = node.style.left; currentTransformer.tf.style.top = node.style.top; currentTransformer.tf.style.width = node.style.width; currentTransformer.tf.style.height = node.style.height; currentTransformer.tf.style.transform = node.style.transform; }
    }
    function onUp(e){ if (!active) return; active=false; try{ handleNode.releasePointerCapture(e.pointerId);}catch(e){} document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); renderActiveOverlay(); }
  }

  function makeRotateHandle(handleNode, el, overlay, node){
    let active=false, center=null, startAngle=0, startRot=0;
    handleNode.addEventListener('pointerdown', function(e){
      e.stopPropagation(); e.preventDefault(); active=true; handleNode.setPointerCapture(e.pointerId);
      const rect = node.getBoundingClientRect(); center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
      startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x); startRot = (el.rotation || 0) * Math.PI/180;
      document.addEventListener('pointermove', onMove); document.addEventListener('pointerup', onUp);
    });
    function onMove(e){ if (!active) return; e.preventDefault(); const ang = Math.atan2(e.clientY - center.y, e.clientX - center.x); const diff = ang - startAngle; const newRot = (startRot + diff) * 180/Math.PI; el.rotation = Math.round(newRot); node.style.transform = `rotate(${el.rotation}deg)`; if (currentTransformer && currentTransformer.tf) currentTransformer.tf.style.transform = node.style.transform; }
    function onUp(e){ if (!active) return; active=false; try{ handleNode.releasePointerCapture(e.pointerId);}catch(e){} document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); renderActiveOverlay(); }
  }

  /* ---------- Add text / symbols / image hooks ---------- */
  function addText(content='Your Text'){ const el = { id: uid('t'), type:'text', x:80,y:80,width:220,height:80,rotation:0,content, fontSize:36, color:'#111' }; getActiveArray().push(el); studio.selectedId = el.id; renderActiveOverlay(); }
  function addSymbol(sym){ const el = { id: uid('s'), type:'symbol', x:100,y:120,width:140,height:140,rotation:0, content: sym, fontSize:72, color:'#000'}; getActiveArray().push(el); studio.selectedId = el.id; renderActiveOverlay(); }

  // Expose global addTextElement so existing HTML button will call this
  window.addTextElement = function(){ addText('Your Text'); };

  // Wire file input (if present)
  const uploadInput = document.getElementById('image-upload-input');
  if (uploadInput){
    uploadInput.addEventListener('change', function(e){
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const el = { id: uid('img'), type:'image', x:90,y:90,width:260,height:260,rotation:0, url };
      getActiveArray().push(el); studio.selectedId = el.id; renderActiveOverlay();
      uploadInput.value = '';
    });
  }

  // symbol picker
  function openSymbolPicker(){
    const picker = document.createElement('div'); picker.style.position='fixed'; picker.style.left='50%'; picker.style.top='50%'; picker.style.transform='translate(-50%,-50%)'; picker.style.background='#fff'; picker.style.padding='12px'; picker.style.border='1px solid #ddd'; picker.style.borderRadius='8px'; picker.style.zIndex=99999;
    const symbols = ['‚òÖ','‚ù§','‚öë','‚ö°','‚òØ','‚ô£','‚òÄ','‚òÅ','‚úà','‚úÇ','üôÇ','üî•','üëë','‚öΩ','üéµ'];
    symbols.forEach(s => { const b = document.createElement('button'); b.textContent=s; b.style.fontSize='22px'; b.style.margin='6px'; b.style.padding='6px'; b.onclick = ()=> { addSymbol(s); document.body.removeChild(picker); }; picker.appendChild(b); });
    const close = document.createElement('button'); close.textContent='Close'; close.style.display='block'; close.style.marginTop='8px'; close.onclick = ()=> document.body.removeChild(picker);
    picker.appendChild(close); document.body.appendChild(picker);
  }

  /* ---------- Clear / Save / Add to cart / Export ---------- */
  window.clearDesign = function(){ studio.sides.front = []; studio.sides.back = []; studio.selectedId = null; renderActiveOverlay(); };

  window.saveDesign = function(){
    try { localStorage.setItem('ct_design_saved', JSON.stringify({ sides: studio.sides, timestamp: Date.now(), productContext: studio.productContext })); }
    catch(e){ console.warn(e); }
    const msg = document.getElementById('design-success'); if (msg){ msg.textContent='Design saved locally'; msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),1800); }
  };

  window.addToCart = async function(){
    const dataUrl = await renderActiveSideDataURL(0.35);
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    cart.push({ id: uid('c'), name: (studio.productContext?.productName) || 'Custom Design', price: (studio.productContext?.productPrice)||29.99, side: studio.activeSide, designThumb: dataUrl });
    localStorage.setItem('ct_cart_v1', JSON.stringify(cart));
    const msg = document.getElementById('design-success'); if (msg){ msg.textContent='Added to cart with design'; msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),1200); }
    // attempt to call site-specific cart UI updates if present
    try { window.updateCartUI && window.updateCartUI(); window.renderCart && window.renderCart(); } catch(e){}
  };

  async function renderActiveSideDataURL(scale=1){
    const w = studio.shirt.width * scale, h = studio.shirt.height * scale;
    const cv = document.createElement('canvas'); cv.width = w; cv.height = h; const ctx = cv.getContext('2d');
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h);
    // draw shirt rounded area
    const sW = w * 0.72, sH = h * 0.78; const sx = (w - sW)/2, sy = (h - sH)/2;
    ctx.save(); roundRect(ctx, sx, sy, sW, sH, Math.min(sW,sH)*0.06); ctx.clip();
    const g = ctx.createLinearGradient(0, sy, 0, sy + sH); g.addColorStop(0, '#ffffff'); g.addColorStop(1, '#f2f2f2'); ctx.fillStyle = g; ctx.fillRect(sx, sy, sW, sH);
    ctx.restore();
    const arr = studio.sides[studio.activeSide] || [];
    for (const el of arr){
      ctx.save();
      const overlayW = 320, overlayH = 420;
      const mapX = (sx + ((el.x + (el.width||0)/2) / overlayW) * sW);
      const mapY = (sy + ((el.y + (el.height||0)/2) / overlayH) * sH);
      const drawW = ((el.width||150) / overlayW) * sW;
      const drawH = ((el.height||80) / overlayH) * sH;
      ctx.translate(mapX, mapY);
      ctx.rotate((el.rotation||0) * Math.PI/180);
      if (el.type === 'image'){
        await new Promise(res => {
          const im = new Image(); im.crossOrigin='anonymous';
          im.onload = ()=> { try{ ctx.drawImage(im, -drawW/2, -drawH/2, drawW, drawH); }catch(e){} res(); };
          im.onerror = ()=> res();
          im.src = el.url;
        });
      } else {
        const fontSizeScaled = (el.fontSize||32) * (sW/overlayW);
        ctx.fillStyle = el.color || '#111'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font = `${Math.round(fontSizeScaled)}px sans-serif`;
        const lines = String(el.content||'').split('\n');
        const totalH = lines.length * fontSizeScaled * 1.1;
        let startY = - (totalH/2) + (fontSizeScaled/2);
        for (const line of lines){ ctx.fillText(line, 0, startY); startY += fontSizeScaled * 1.1; }
      }
      ctx.restore();
    }
    return cv.toDataURL('image/png');
  }

  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  async function exportActiveSideAsPNG(){ const url = await renderActiveSideDataURL(1); const a = document.createElement('a'); a.href = url; a.download = `shirt-${studio.activeSide}-${Date.now()}.png`; a.click(); }

  // transform save/load if existing saved design present
  try {
    const loaded = JSON.parse(localStorage.getItem('ct_design_saved') || 'null');
    if (loaded && loaded.sides) studio.sides = loaded.sides;
    else studio.sides.front.push({ id: uid('welcome'), type:'text', x:80, y:90, width:240, height:90, rotation:0, content:'CUSTOM THREADS', fontSize:28, color:'#0b0b0b' });
  } catch(e){ console.warn(e); }

  function renderActiveOverlay(){ front.overlay.innerHTML=''; back.overlay.innerHTML=''; (studio.sides.front||[]).forEach(el=>renderElementTo(front.overlay, el)); (studio.sides.back||[]).forEach(el=>renderElementTo(back.overlay, el)); }
  function renderElementTo(overlay, el){ const node = makeNode(el); node.addEventListener('pointerdown', elPointerDown); overlay.appendChild(node); if (studio.selectedId === el.id && overlay === (studio.activeSide==='front'?front.overlay:back.overlay)) attachTransformer(node, el, overlay); }

  // expose small API for product context
  window.__ct_setProductContext = function(ctx){ studio.productContext = ctx || null; const pName = document.getElementById('design-product-name'); if (pName) pName.textContent = ctx?.productName || 'Custom Design'; };

  // expose some functions to global scope (so existing buttons still work)
  window.saveDesign = window.saveDesign || window.saveDesign;
  window.addToCart = window.addToCart || window.addToCart;
  window.clearDesign = window.clearDesign || window.clearDesign;
  window.exportDesignPNG = window.exportDesignPNG || exportActiveSideAsPNG;
  window.selectColor = function(c){ front.face.style.background = c; back.face.style.background = c; };
  window.selectSize = function(s){ window._selectedProductSize = s; alert('Size ' + s + ' selected'); };

  // initial render
  showSide('front'); renderActiveOverlay();

  // keyboard actions (move with arrows, delete to remove)
  window.addEventListener('keydown', function(e){
    if (!studio.selectedId) return;
    const arr = studio.sides[studio.activeSide]; const idx = arr.findIndex(x=>x.id===studio.selectedId); if (idx === -1) return;
    if (e.key === 'ArrowUp') { arr[idx].y -= 2; renderActiveOverlay(); }
    if (e.key === 'ArrowDown') { arr[idx].y += 2; renderActiveOverlay(); }
    if (e.key === 'ArrowLeft') { arr[idx].x -= 2; renderActiveOverlay(); }
    if (e.key === 'ArrowRight') { arr[idx].x += 2; renderActiveOverlay(); }
    if (e.key === 'Delete' || e.key === 'Backspace') { arr.splice(idx,1); studio.selectedId = null; renderActiveOverlay(); }
  });

  console.log('DesignStudio 3D enhancer installed and linked into page.');

})();


const stripe = require('stripe')('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');
const express = require('express');
const app = express();

app.post('/create-payment-intent', async (req, res) => {
    const { amount, currency, customer } = req.body;
    
    const paymentIntent = await stripe.paymentIntents.create({
        amount: amount,
        currency: currency,
        receipt_email: customer.email,
        metadata: { customer: JSON.stringify(customer) }
    });
    
    res.json({ clientSecret: paymentIntent.client_secret });
});

app.listen(3000);     (function(){
  // helpers
  const $ = s => document.querySelector(s);
  const uid = (p='id') => `${p}-${Date.now()}-${Math.floor(Math.random()*9000+1000)}`;
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  function escapeHtml(s){ return String(s||''); }

  // find or create design-canvas container inside DesignStudio
  const designSection = document.getElementById('DesignStudio');
  if (!designSection) {
    console.error('DesignStudio section not found ‚Äî paste this script after the DesignStudio section exists.');
    return;
  }
  let container = document.getElementById('design-canvas');
  if (!container) {
    container = document.createElement('div');
    container.id = 'design-canvas';
    container.className = 'relative';
    container.style.width = '500px';
    container.style.height = '600px';
    container.style.margin = '0 auto';
    container.style.touchAction = 'none';
    designSection.appendChild(container);
  } else {
    container.innerHTML = '';
    container.style.touchAction = 'none';
  }

  // guard to avoid double-init
  if (container.dataset.ctCanvasInit === '1') return;
  container.dataset.ctCanvasInit = '1';

  // create canvas and overlay
  const canvas = document.createElement('canvas');
  const CANVAS_W = 900; // high-res internal for nicer exports
  const CANVAS_H = 1080;
  canvas.id = 'design-canvas-canvas';
  canvas.width = CANVAS_W;
  canvas.height = CANVAS_H;
  canvas.style.width = '450px';
  canvas.style.height = '540px';
  canvas.style.display = 'block';
  canvas.style.margin = '0 auto';
  canvas.style.background = '#fff';
  canvas.style.borderRadius = '12px';
  canvas.style.boxShadow = '0 8px 24px rgba(0,0,0,.08)';
  container.appendChild(canvas);

  // overlay for interactive elements (1:2 scale relative to internal canvas)
  const overlay = document.createElement('div');
  overlay.id = 'design-overlay';
  overlay.style.position = 'absolute';
  overlay.style.left = '50%';
  overlay.style.top = '50%';
  overlay.style.width = '320px';
  overlay.style.height = '420px';
  overlay.style.marginLeft = '-160px';
  overlay.style.marginTop = '-210px';
  overlay.style.pointerEvents = 'auto';
  overlay.style.touchAction = 'none';
  container.appendChild(overlay);

  // small UI area below canvas for controls (if not present)
  const controlsWrap = document.createElement('div');
  controlsWrap.style.display = 'flex';
  controlsWrap.style.justifyContent = 'center';
  controlsWrap.style.gap = '8px';
  controlsWrap.style.marginTop = '10px';
  container.appendChild(controlsWrap);

  // draw context
  const ctx = canvas.getContext('2d');

  // state
  const STATE = {
    baseImage: null, // Image object or null (if null we draw silhouette)
    elementAreaW: 320,
    elementAreaH: 420,
    elements: [], // editable elements
    selectedId: null,
    autoSaveKey: 'ct_canvas_design_v1'
  };

  // load saved
  try {
    const saved = JSON.parse(localStorage.getItem(STATE.autoSaveKey) || 'null');
    if (saved && saved.elements) {
      STATE.elements = saved.elements;
      if (saved.baseImageDataUrl) {
        const im = new Image();
        im.onload = () => { STATE.baseImage = im; redraw(); };
        im.src = saved.baseImageDataUrl;
      }
    }
  } catch(e){ /* ignore */ }

  // utility map from overlay coords to canvas coords
  function overlayToCanvasX(x){ // overlay units -> canvas px
    const sx = ( ( ( (CANVAS_W*0.72) / STATE.elementAreaW ) ) );
    // compute shirt inner area origin
    const sW = CANVAS_W * 0.72;
    const sxOffset = (CANVAS_W - sW)/2;
    return sxOffset + (x / STATE.elementAreaW) * sW;
  }
  function overlayToCanvasY(y){
    const sH = CANVAS_H * 0.78;
    const syOffset = (CANVAS_H - sH)/2;
    return syOffset + (y / STATE.elementAreaH) * sH;
  }
  function overlayToCanvasW(w){
    const sW = CANVAS_W * 0.72;
    return (w / STATE.elementAreaW) * sW;
  }
  function overlayToCanvasH(h){
    const sH = CANVAS_H * 0.78;
    return (h / STATE.elementAreaH) * sH;
  }

  // base shirt draw (when no image)
  function drawShirtBase(){
    // draw background
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
    // rounded rect center
    const sW = CANVAS_W * 0.72, sH = CANVAS_H * 0.78;
    const sx = (CANVAS_W - sW)/2, sy = (CANVAS_H - sH)/2;
    // rounded mask
    ctx.save();
    roundRect(ctx, sx, sy, sW, sH, Math.min(sW,sH)*0.06);
    ctx.clip();
    const g = ctx.createLinearGradient(0, sy, 0, sy + sH); g.addColorStop(0, '#ffffff'); g.addColorStop(1, '#f6f6f6');
    ctx.fillStyle = g; ctx.fillRect(sx, sy, sW, sH);
    ctx.restore();
    // thin border
    ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth = 2; roundRectStroke(ctx, sx, sy, sW, sH, Math.min(sW,sH)*0.06);
  }

  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function roundRectStroke(ctx,x,y,w,h,r){ roundRect(ctx,x,y,w,h,r); ctx.stroke(); }

  // primary redraw: compose base image/shirt and elements
  async function redraw(){
    // clear
    ctx.clearRect(0,0,CANVAS_W,CANVAS_H);
    // base
    if (STATE.baseImage) {
      // draw fitted into shirt inner area
      const sW = CANVAS_W * 0.72, sH = CANVAS_H * 0.78;
      const sx = (CANVAS_W - sW)/2, sy = (CANVAS_H - sH)/2;
      // draw base image to fill purely (cover)
      const im = STATE.baseImage;
      // compute aspect fit-cover
      const imRatio = im.width / im.height, boxRatio = sW / sH;
      let dw= sW, dh = sH, dx = sx, dy = sy;
      if (imRatio > boxRatio) { // wider, crop sides
        dh = sH; dw = im.width * (sH / im.height); dx = sx - (dw - sW)/2;
      } else {
        dw = sW; dh = im.height * (sW / im.width); dy = sy - (dh - sH)/2;
      }
      ctx.drawImage(im, dx, dy, dw, dh);
    } else {
      drawShirtBase();
    }

    // draw elements (respect order)
    for (const el of STATE.elements){
      ctx.save();
      const cx = overlayToCanvasX(el.x + (el.width||0)/2);
      const cy = overlayToCanvasY(el.y + (el.height||0)/2);
      const dw = overlayToCanvasW(el.width || 150);
      const dh = overlayToCanvasH(el.height || 80);
      ctx.translate(cx, cy);
      ctx.rotate((el.rotation||0) * Math.PI / 180);
      if (el.type === 'image'){
        try {
          await new Promise((res)=> {
            const im = new Image(); im.crossOrigin = 'anonymous';
            im.onload = ()=> { ctx.drawImage(im, -dw/2, -dh/2, dw, dh); res(); };
            im.onerror = ()=> res();
            im.src = el.url;
          });
        } catch(e){}
      } else {
        // text or symbol
        const fs = (el.fontSize || 32) * ( (overlayToCanvasW(200) / 200) ); // scale factor
        ctx.fillStyle = el.color || '#111';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `${Math.round((el.fontSize||32) * (dw / (overlayToCanvasW(el.width||150)||150))) }px sans-serif`;
        const lines = String(el.content||'').split('\n');
        const lineH = (el.fontSize || 32) * 1.05;
        // draw stacked
        let y0 = -(lines.length-1) * (lineH/2);
        for (const ln of lines) { ctx.fillText(ln, 0, y0); y0 += lineH; }
      }
      ctx.restore();
    }
  }

  // build overlay DOM for editing and mirror state -> overlay
  function refreshOverlay(){
    overlay.innerHTML = '';
    // scale overlay size styling based on canvas displayed size (it is already static)
    for (const el of STATE.elements){
      const node = document.createElement('div');
      node.className = 'overlay-el';
      node.dataset.id = el.id;
      node.style.position = 'absolute';
      node.style.left = el.x + 'px';
      node.style.top = el.y + 'px';
      node.style.width = (el.width || 150) + 'px';
      node.style.height = (el.height || 80) + 'px';
      node.style.transform = `rotate(${el.rotation||0}deg)`;
      node.style.transformOrigin = 'center center';
      node.style.cursor = 'grab';
      node.style.display = 'flex';
      node.style.alignItems = 'center';
      node.style.justifyContent = 'center';
      node.style.userSelect = 'none';
      node.style.touchAction = 'none';
      node.style.background = 'transparent';
      node.style.outline = STATE.selectedId === el.id ? '2px dashed rgba(59,130,246,.6)' : 'none';

      if (el.type === 'text' || el.type === 'symbol'){
        const t = document.createElement('div');
        t.textContent = el.content;
        t.style.pointerEvents = 'none';
        t.style.color = el.color || '#000';
        t.style.fontSize = (el.fontSize || 32) + 'px';
        t.style.textAlign = 'center';
        t.style.whiteSpace = 'pre-wrap';
        node.appendChild(t);
      } else if (el.type === 'image'){
        const img = document.createElement('img');
        img.src = el.url;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.draggable = false;
        img.style.pointerEvents = 'none';
        node.appendChild(img);
      }

      // pointer handlers for drag
      node.addEventListener('pointerdown', (ev)=> elementPointerDown(ev, el));
      overlay.appendChild(node);

      // if selected add handles: 4 corner resizers + rotate handle
      if (STATE.selectedId === el.id) attachHandles(node, el);
    }
  }

  // interaction: pointer drag
  let dragState = null;
  function elementPointerDown(e, el){
    e.stopPropagation(); e.preventDefault();
    STATE.selectedId = el.id;
    refreshOverlay();
    // capture pointer
    const node = e.currentTarget;
    try { node.setPointerCapture(e.pointerId); } catch(e){}
    dragState = { id: el.id, startX: e.clientX, startY: e.clientY, origX: el.x, origY: el.y, node, pointerId: e.pointerId };
    document.addEventListener('pointermove', onElementDrag);
    document.addEventListener('pointerup', onElementUp);
    document.addEventListener('pointercancel', onElementUp);
  }
  function onElementDrag(e){
    if (!dragState || e.pointerId !== dragState.pointerId) return;
    e.preventDefault();
    const dx = e.clientX - dragState.startX;
    const dy = e.clientY - dragState.startY;
    const el = STATE.elements.find(x=>x.id===dragState.id);
    if (!el) return;
    el.x = clamp(Math.round(dragState.origX + dx), -1000, 1000);
    el.y = clamp(Math.round(dragState.origY + dy), -1000, 1000);
    dragState.node.style.left = el.x + 'px';
    dragState.node.style.top = el.y + 'px';
    // live redraw to canvas
    scheduleRedraw();
  }
  function onElementUp(e){
    if (!dragState || e.pointerId !== dragState.pointerId) return;
    try { dragState.node.releasePointerCapture(e.pointerId); } catch(e){}
    document.removeEventListener('pointermove', onElementDrag);
    document.removeEventListener('pointerup', onElementUp);
    document.removeEventListener('pointercancel', onElementUp);
    dragState = null;
    autosave();
  }

  // attach handles (resize/rotate)
  function attachHandles(node, el){
    // resizer corners
    const pos = ['tl','tr','bl','br'];
    pos.forEach(p=>{
      const h = document.createElement('div');
      h.className = 'handle ' + p;
      h.style.width='12px'; h.style.height='12px'; h.style.background='#fff'; h.style.border='1px solid rgba(0,0,0,.6)';
      h.style.position='absolute'; h.style.pointerEvents='auto';
      if (p==='tl'){ h.style.left='-6px'; h.style.top='-6px'; }
      if (p==='tr'){ h.style.right='-6px'; h.style.top='-6px'; }
      if (p==='bl'){ h.style.left='-6px'; h.style.bottom='-6px'; }
      if (p==='br'){ h.style.right='-6px'; h.style.bottom='-6px'; }
      node.appendChild(h);
      makeResizer(h, el, node, p);
    });
    // rotate handle
    const rh = document.createElement('div');
    rh.className = 'rotate-handle';
    rh.style.width='14px'; rh.style.height='14px'; rh.style.borderRadius='50%'; rh.style.background='#fff'; rh.style.border='1px solid rgba(0,0,0,.6)';
    rh.style.position='absolute'; rh.style.left='50%'; rh.style.top='-26px'; rh.style.transform='translateX(-50%)'; rh.style.pointerEvents='auto';
    node.appendChild(rh);
    makeRotator(rh, el, node);
  }

  function makeResizer(h, el, node, pos){
    let active=false, start=null, startW, startH, startX, startY;
    h.addEventListener('pointerdown', function(e){
      e.stopPropagation(); e.preventDefault(); active=true; h.setPointerCapture(e.pointerId);
      start = { x:e.clientX, y:e.clientY }; startW = el.width || parseInt(node.style.width) || 150; startH = el.height || parseInt(node.style.height) || 80;
      startX = el.x; startY = el.y;
      document.addEventListener('pointermove', onMove); document.addEventListener('pointerup', onUp);
    });
    function onMove(e){
      if (!active) return; e.preventDefault();
      const dx = e.clientX - start.x, dy = e.clientY - start.y;
      let nw=startW, nh=startH, nx=startX, ny=startY;
      if (pos==='br'){ nw = Math.max(20, startW + dx); nh = Math.max(20, startH + dy); }
      if (pos==='tr'){ nw = Math.max(20, startW + dx); nh = Math.max(20, startH - dy); ny = startY + dy; }
      if (pos==='bl'){ nw = Math.max(20, startW - dx); nh = Math.max(20, startH + dy); nx = startX + dx; }
      if (pos==='tl'){ nw = Math.max(20, startW - dx); nh = Math.max(20, startH - dy); nx = startX + dx; ny = startY + dy; }
      el.width = Math.round(nw); el.height = Math.round(nh); el.x = Math.round(nx); el.y = Math.round(ny);
      node.style.width = el.width + 'px'; node.style.height = el.height + 'px';
      node.style.left = el.x + 'px'; node.style.top = el.y + 'px';
      scheduleRedraw();
    }
    function onUp(e){ if (!active) return; active=false; try{ h.releasePointerCapture(e.pointerId);}catch(ex){} document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); autosave(); }
  }

  function makeRotator(h, el, node){
    let active=false, center=null, startAngle=0, startRot=0;
    h.addEventListener('pointerdown', function(e){
      e.stopPropagation(); e.preventDefault(); active=true; h.setPointerCapture(e.pointerId);
      const rect = node.getBoundingClientRect(); center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
      startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x); startRot = (el.rotation || 0) * Math.PI/180;
      document.addEventListener('pointermove', onMove); document.addEventListener('pointerup', onUp);
    });
    function onMove(e){
      if (!active) return; e.preventDefault();
      const ang = Math.atan2(e.clientY - center.y, e.clientX - center.x);
      const diff = ang - startAngle;
      const newRot = (startRot + diff) * 180/Math.PI;
      el.rotation = Math.round(newRot);
      node.style.transform = `rotate(${el.rotation}deg)`;
      scheduleRedraw();
    }
    function onUp(e){ if (!active) return; active=false; try{ h.releasePointerCapture(e.pointerId);}catch(ex){} document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); autosave(); }
  }

  // small debounce for redraw
  let redrawTimer = null;
  function scheduleRedraw(){
    if (redrawTimer) clearTimeout(redrawTimer);
    redrawTimer = setTimeout(()=>{ redrawTimer=null; redraw(); }, 16);
    // update overlay positions too
    // update overlay DOM left/top/size for live feel
    // (overlay nodes already updated in drag handlers)
  }

  // autosave design state
  function autosave(){
    try {
      const payload = { elements: STATE.elements, baseImageDataUrl: STATE.baseImage ? STATE.baseImage.src : null, savedAt: Date.now() };
      localStorage.setItem(STATE.autoSaveKey, JSON.stringify(payload));
    } catch(e){ console.warn('autosave failed', e); }
  }

  // public functions to add elements (override existing buttons)
  window.addTextElement = function(){
    const el = { id: uid('t'), type:'text', x:40, y:40, width:240, height:90, rotation:0, content:'Your Text', fontSize:36, color:'#111' };
    STATE.elements.push(el);
    STATE.selectedId = el.id;
    refreshOverlay(); scheduleRedraw(); autosave();
  };

  // hook existing file input for images (if present)
  const imageInput = document.getElementById('image-upload-input');
  if (imageInput){
    imageInput.addEventListener('change', function(e){
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const el = { id: uid('img'), type:'image', x:60, y:60, width:220, height:220, rotation:0, url };
      STATE.elements.push(el);
      STATE.selectedId = el.id;
      refreshOverlay(); scheduleRedraw(); autosave();
      imageInput.value = '';
    });
  }

  // allow uploading a base garment image (so additions are on top of the garment image)
  const baseUploaderBtn = document.createElement('button');
  baseUploaderBtn.textContent = 'Upload Garment';
  baseUploaderBtn.style.padding = '6px 8px';
  baseUploaderBtn.style.border = '1px solid #ddd';
  baseUploaderBtn.onclick = ()=> {
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = (ev)=> {
      const f = ev.target.files && ev.target.files[0]; if (!f) return;
      const r = new FileReader(); r.onload = ()=> {
        const img = new Image(); img.onload = ()=>{
          STATE.baseImage = img; redraw(); autosave();
        }; img.src = r.result;
      }; r.readAsDataURL(f);
    };
    inp.click();
  };
  controlsWrap.appendChild(baseUploaderBtn);

  // export and save functions (override)
  window.exportDesignPNG = async function(){
    await redraw(); // ensure latest
    const data = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = data; a.download = `design-${Date.now()}.png`; a.click();
  };

  window.saveDesign = function(){
    autosave();
    const msg = document.getElementById('design-success');
    if (msg){ msg.textContent = 'Design saved'; msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),1500); }
  };

  // Add-to-cart: attach a thumbnail & design JSON to cart saved in localStorage
  window.addToCart = async function(){
    await redraw();
    const thumb = canvas.toDataURL('image/png');
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    cart.push({ id: uid('c'), name: 'Custom Design', price: 29.99, qty:1, designThumb: thumb, designData: JSON.parse(JSON.stringify(STATE)) });
    localStorage.setItem('ct_cart_v1', JSON.stringify(cart));
    // call site update if present
    try { window.updateCartUI && window.updateCartUI(); window.renderCart && window.renderCart(); } catch(e){}
    const msg = document.getElementById('design-success');
    if (msg){ msg.textContent = 'Added to cart'; msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),1400); }
  };

  // clear
  window.clearDesign = function(){
    STATE.elements = []; STATE.baseImage = null; STATE.selectedId = null; refreshOverlay(); redraw(); autosave();
  };

  // load/update overlay and canvas initially
  function refreshOverlayAndCanvas(){
    refreshOverlay();
    redraw();
  }
  refreshOverlayAndCanvas();

  // clicking overlay background deselects
  overlay.addEventListener('pointerdown', function(e){
    if (e.target === overlay) { STATE.selectedId = null; refreshOverlay(); autosave(); }
  });

  // small UI: quick Add Text & Export
  const quickAddText = document.createElement('button');
  quickAddText.textContent = 'Add Text';
  quickAddText.style.padding = '6px 8px'; quickAddText.style.border='1px solid #ddd';
  quickAddText.onclick = ()=> window.addTextElement();
  controlsWrap.appendChild(quickAddText);

  const quickExport = document.createElement('button');
  quickExport.textContent = 'Export PNG';
  quickExport.style.padding = '6px 8px'; quickExport.style.border='1px solid #ddd';
  quickExport.onclick = ()=> window.exportDesignPNG();
  controlsWrap.appendChild(quickExport);

  // refresh overlay when window resizes (visual only)
  window.addEventListener('resize', ()=> { refreshOverlay(); });

  // keep overlay in sync with state after actions
  // autosave on page unload
  window.addEventListener('beforeunload', autosave);

  // expose STATE for debugging
  window.__ct_canvas_state = STATE;

})();

// Handle URL hash (e.g., new.html#cart)
window.addEventListener('DOMContentLoaded', () => {
    if (window.location.hash === '#cart') {
        showCart();
    }
});


    /* ====== Proceed to Checkout: self-contained handler ====== */
/* Paste this into your main JS file or in a <script> near the end of the body. */

async function ensureCartNormalized() {
  // ensure each cart item has a primaryImage for display
  const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
  let changed = false;
  for (let i = 0; i < cart.length; i++) {
    const it = cart[i];
    if (!it.primaryImage) {
      // try common fallbacks
      if (it.image) { it.primaryImage = it.image; changed = true; }
      else if (it.thumbnails && (it.thumbnails.front || it.thumbnails[Object.keys(it.thumbnails || {})[0]])) {
        it.primaryImage = it.thumbnails.front || it.thumbnails[Object.keys(it.thumbnails)[0]];
        changed = true;
      } else if (it.customDesign && it.customDesign.thumbnails) {
        // pick first thumbnail
        const keys = Object.keys(it.customDesign.thumbnails || {});
        if (keys.length) {
          it.primaryImage = it.customDesign.thumbnails[keys[0]];
          changed = true;
        }
      }
      // fallback: placeholder generator if you have it, otherwise empty string
      if (!it.primaryImage) {
        try {
          it.primaryImage = (typeof placeholderDataUrl === 'function') ? placeholderDataUrl() : '';
          changed = true;
        } catch (e) {
          it.primaryImage = '';
        }
      }
    }
  }
  if (changed) localStorage.setItem('ct_cart_v1', JSON.stringify(cart));
  return cart;
}

function currency(n){ return '$' + Number(n||0).toFixed(2); }

function createCheckoutModal() {
  // if modal exists return it
  let modal = document.getElementById('checkout-modal');
  if (modal) return modal;

  modal = document.createElement('div');
  modal.id = 'checkout-modal';
  modal.style.position = 'fixed';
  modal.style.left = '0';
  modal.style.top = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.background = 'rgba(0,0,0,0.5)';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.zIndex = '9999';

  modal.innerHTML = `
    <div id="checkout-modal-card" style="width:92%;max-width:900px;background:#fff;border-radius:8px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.2);">
      <button id="checkout-modal-close" style="float:right;border:none;background:transparent;font-size:20px;cursor:pointer">‚úï</button>
      <h2 style="margin-top:0">Order summary</h2>
      <div id="checkout-modal-items" style="max-height:300px;overflow:auto;margin-bottom:12px"></div>
      <div id="checkout-modal-totals" style="margin-bottom:12px"></div>

      <h3 style="margin-bottom:8px">Shipping & contact</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <input id="co-name" placeholder="Full name" style="padding:8px;border:1px solid #ddd;border-radius:4px" />
        <input id="co-email" placeholder="Email" style="padding:8px;border:1px solid #ddd;border-radius:4px" />
      </div>
      <input id="co-address" placeholder="Shipping address" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;margin-bottom:8px" />

      <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
        <button id="checkout-confirm-pay" style="background:#1f6feb;color:#fff;padding:10px 16px;border-radius:6px;border:none;cursor:pointer">Pay now</button>
        <button id="checkout-cancel" style="background:#eee;padding:10px 14px;border-radius:6px;border:none;cursor:pointer">Cancel</button>
      </div>

      <div id="checkout-message" style="margin-top:12px;color:green;display:none"></div>
    </div>
  `;

  document.body.appendChild(modal);

  // close handlers
  modal.querySelector('#checkout-modal-close').addEventListener('click', () => modal.remove());
  modal.querySelector('#checkout-cancel').addEventListener('click', () => modal.remove());

  return modal;
}

/* Build items HTML (compact) */
function buildCheckoutItemsHtml(cart) {
    if (!cart || !cart.length) return '<p>Your cart is empty.</p>';
    
    return cart.map(it => {
        // Determine best image source
        let imgSrc = '';
        if (it.primaryImage) {
            imgSrc = it.primaryImage;
        } else if (it.image) {
            imgSrc = it.image;
        } else if (it.customDesign && it.customDesign.thumbnails) {
            const thumbs = it.customDesign.thumbnails;
            imgSrc = thumbs.front || thumbs[Object.keys(thumbs)[0]] || '';
        }
        
        const name = escHtml(it.name || 'Custom product');
        const qty = Number(it.quantity || it.qty || 1);
        const price = Number(it.price || 0);
        const line = (qty * price).toFixed(2);
        
        const itemDesc = it.isCustom 
            ? `Custom Design (${it.customDesign?.activeSides?.join(', ') || 'front'})` 
            : `${it.size || ''} ${it.color || ''}`.trim();
        
        return `
            <div style="display:flex;gap:12px;padding:8px 0;border-bottom:1px solid #f0f0f0">
                ${imgSrc ? `
                    <img src="${imgSrc}" 
                         style="width:72px;height:72px;object-fit:cover;border:2px solid #e5e7eb;border-radius:8px;background:#f9fafb"
                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" />
                    <div style="width:72px;height:72px;display:none;align-items:center;justify-content:center;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;font-size:2rem;">
                        ${it.icon || 'üì¶'}
                    </div>
                ` : `
                    <div style="width:72px;height:72px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;font-size:2rem;">
                        ${it.icon || 'üì¶'}
                    </div>
                `}
                <div style="flex:1">
                    <div style="font-weight:600">${name}</div>
                    <div style="color:#666;font-size:13px">${itemDesc}</div>
                    <div style="color:#666;font-size:13px">Qty: ${qty}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-weight:600">${currency(price)}</div>
                    <div style="color:#666;font-size:13px">${currency(line)}</div>
                </div>
            </div>
        `;
    }).join('');
}
/* small helper to escape */
function escHtml(s=''){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* Main proceed function */
async function proceedToCheckout(e) {
  e && e.preventDefault && e.preventDefault();

  // normalize cart and load
  const cart = await ensureCartNormalized();
  if (!cart || !cart.length) {
    alert('Your cart is empty.');
    return;
  }

  // create modal and populate
  const modal = createCheckoutModal();
  const itemsEl = modal.querySelector('#checkout-modal-items');
  const totalsEl = modal.querySelector('#checkout-modal-totals');
  itemsEl.innerHTML = buildCheckoutItemsHtml(cart);

  // totals calculation (simple)
  const subtotal = cart.reduce((s,i) => s + (Number(i.price||0) * Number(i.quantity||i.qty||1)), 0);
  const tax = +(subtotal * 0.01 ).toFixed(2); // example 10% tax
  const shipping = subtotal > 50 ? 0 : 5.99; // sample rule
  const total = +(subtotal + tax + shipping).toFixed(2);

  totalsEl.innerHTML = `
    <div style="display:flex;justify-content:space-between;margin:6px 0"><div>Subtotal</div><div>${currency(subtotal)}</div></div>
    <div style="display:flex;justify-content:space-between;margin:6px 0"><div>Tax (10%)</div><div>${currency(tax)}</div></div>
    <div style="display:flex;justify-content:space-between;margin:6px 0"><div>Shipping</div><div>${currency(shipping)}</div></div>
    <hr />
    <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:8px"><div>Total</div><div>${currency(total)}</div></div>
  `;

  // show modal
  modal.style.display = 'flex';

  // pre-fill name/email if available from Auth
  try {
    const user = (typeof Auth !== 'undefined' && Auth.getCurrentUser) ? Auth.getCurrentUser() : null;
    if (user) {
      const n = modal.querySelector('#co-name'); const em = modal.querySelector('#co-email');
      if (n && user.name) n.value = user.name;
      if (em && user.email) em.value = user.email;
    }
  } catch (err) {
    console.warn('Could not prefill user details', err);
  }

  // wire pay button
  const payBtn = modal.querySelector('#checkout-confirm-pay');
  payBtn.onclick = async function payHandler() {
    // basic validation
    const name = modal.querySelector('#co-name').value.trim();
    const email = modal.querySelector('#co-email').value.trim();
    const address = modal.querySelector('#co-address').value.trim();
    if (!name || !email || !address) {
      alert('Please enter name, email and address.');
      return;
    }

    // disable UI while "processing"
    payBtn.disabled = true; payBtn.textContent = 'Processing‚Ä¶';

    // Build a simple order object
    const order = {
      id: 'order_' + Date.now(),
      createdAt: Date.now(),
      items: cart,
      subtotal, tax, shipping, total,
      customer: { name, email, address },
      status: 'processing'
    };

    // *** Replace this block with your real payment integration ***
    // For now, simulate a short async payment operation:
    await new Promise(res => setTimeout(res, 1100));
    const paymentSuccess = true; // change based on integration result
    // *************************************************************

    if (paymentSuccess) {
      // mark order success
      order.status = 'paid';
      // Save order somewhere: localStorage for demo OR send to server
      try {
        // append to local order history (demo)
        const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
        orders.push(order);
        localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
      } catch (err) { console.warn('Order save failed', err); }

      // clear cart in localStorage and attempt to update server (Auth)
      localStorage.setItem('ct_cart_v1', JSON.stringify([]));
      try {
        if (typeof Auth !== 'undefined' && Auth.getCurrentUser && Auth.updateUser) {
          const user = Auth.getCurrentUser();
          if (user) {
            user.cart = [];
            await Auth.updateUser({ cart: user.cart });
          }
        }
      } catch (err) {
        console.warn('Could not update server cart', err);
      }

      // show success message
      const msg = modal.querySelector('#checkout-message');
      msg.style.display = 'block';
      msg.textContent = 'Payment successful ‚Äî thank you! Order ID: ' + order.id;

      // update UI: close modal after short delay and refresh checkout UI if present
      setTimeout(() => {
        modal.remove();
        // re-render checkout root if you have a render function
        if (window.renderCheckout) try { window.renderCheckout(); } catch(e){}
        if (window.updateCartCount) try { window.updateCartCount(); } catch(e){}
        // optional: navigate to orders / confirmation page
        // window.location.href = '#'; // uncomment if you have orders page
      }, 1400);
    } else {
      alert('Payment failed. Please try again.');
      payBtn.disabled = false; payBtn.textContent = 'Pay now';
    }
  };
}

/* Attach handler to buttons with id "checkout-pay-btn" and class ".proceed-to-checkout" on DOM ready */
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('checkout-pay-btn');
  if (btn) btn.addEventListener('click', proceedToCheckout);
  document.querySelectorAll('.proceed-to-checkout').forEach(el => el.addEventListener('click', proceedToCheckout));
});


    // Advanced Cart System
function openAdvancedCart() {
    document.getElementById('advanced-cart-modal').classList.add('open');
    document.getElementById('cart-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
    renderAdvancedCart();
}

function closeAdvancedCart() {
    document.getElementById('advanced-cart-modal').classList.remove('open');
    document.getElementById('cart-overlay').classList.remove('open');
    document.body.style.overflow = '';
}

function renderAdvancedCart() {
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    const body = document.getElementById('advanced-cart-body');
    const footer = document.getElementById('advanced-cart-footer');
    
    if (cart.length === 0) {
        body.innerHTML = `
            <div class="cart-empty">
                <div class="cart-empty-icon">üõí</div>
                <h3 style="margin-bottom: 0.5rem; color: #1a1a1a;">Your cart is empty</h3>
                <p>Add some items to get started!</p>
            </div>
        `;
        footer.innerHTML = `
            <button class="continue-shopping" onclick="closeAdvancedCart()">Continue Shopping</button>
        `;
        return;
    }
    
    // Render items
   let itemsHtml = '';
 cart.forEach((item, index) => {
    const qty = item.quantity || 1;
    const price = item.price || 0;
    const lineTotal = (qty * price).toFixed(2);
    
    // Determine the best image to display
    let displayImage = null;
    let imageType = 'icon'; // 'icon', 'image', or 'thumbnail'
    
    // Priority: primaryImage > image > customDesign thumbnails > icon
    if (item.primaryImage) {
        displayImage = item.primaryImage;
        imageType = 'image';
    } else if (item.image) {
        displayImage = item.image;
        imageType = 'image';
    } else if (item.customDesign && item.customDesign.thumbnails) {
        const thumbnails = item.customDesign.thumbnails;
        displayImage = thumbnails.front || thumbnails[Object.keys(thumbnails)[0]];
        imageType = 'image';
    }
    
    // Build item description
    const itemDesc = item.isCustom 
        ? `Custom Design ‚Ä¢ ${item.customDesign?.activeSides?.length || 1} side(s)` 
        : `${item.size ? `Size: ${item.size}` : ''} ${item.color ? `| Color: ${item.color}` : ''}`;
    
    itemsHtml += `
        <div class="advanced-cart-item">
            ${imageType === 'image' ? `
                <div class="cart-item-img" style="
                    background-image: url('${displayImage}');
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    border: 2px solid #e5e7eb;
                ">
                    ${item.isCustom ? '<span style="position: absolute; bottom: 2px; right: 2px; background: #3b82f6; color: white; font-size: 9px; padding: 2px 4px; border-radius: 3px;">CUSTOM</span>' : ''}
                </div>
            ` : `
                <div class="cart-item-img">
                    ${item.icon || 'üì¶'}
                </div>
            `}
            
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name || 'Product'}</div>
                <div class="cart-item-details">${itemDesc}</div>
                <div class="cart-item-price">$${lineTotal}</div>
                <div class="cart-item-actions">
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateAdvancedCartQty(${index}, -1)">‚àí</button>
                        <span class="qty-display">${qty}</span>
                        <button class="qty-btn" onclick="updateAdvancedCartQty(${index}, 1)">+</button>
                    </div>
                    <button class="remove-btn" onclick="removeAdvancedCartItem(${index})" title="Remove item">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `;
});
    
    body.innerHTML = itemsHtml;
    
    // Calculate totals
    const subtotal = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
    const shipping = subtotal > 75 ? 0 : 1.00;
    const tax = subtotal * 0.01;
    const total = subtotal + shipping + tax;
    
    // Render footer
    footer.innerHTML = `
        <div class="cart-summary">
            <div class="summary-row">
                <span>Subtotal</span>
                <span>$${subtotal.toFixed(2)}</span>
            </div>
            <div class="summary-row">
                <span>Shipping</span>
                <span>${shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2)}</span>
            </div>
            <div class="summary-row">
                <span>Tax (10%)</span>
                <span>$${tax.toFixed(2)}</span>
            </div>
            <div class="summary-row total">
                <span>Total</span>
                <span>$${total.toFixed(2)}</span>
            </div>
        </div>
        <button class="checkout-btn" onclick="proceedToCheckout()">Proceed to Checkout</button>
        <button class="continue-shopping" onclick="closeAdvancedCart()">Continue Shopping</button>
    `;
}

function updateAdvancedCartQty(index, change) {
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    if (cart[index]) {
        const newQty = Math.max(1, (cart[index].quantity || 1) + change);
        cart[index].quantity = newQty;
        localStorage.setItem('ct_cart_v1', JSON.stringify(cart));
        updateCartCount();
        renderAdvancedCart();
    }
}

function removeAdvancedCartItem(index) {
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    cart.splice(index, 1);
    localStorage.setItem('ct_cart_v1', JSON.stringify(cart));
    updateCartCount();
    renderAdvancedCart();
}


    // Advanced Checkout System
function proceedToCheckout() {
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    if (cart.length === 0) {
        alert('Your cart is empty');
        return;
    }
    
    closeAdvancedCart();
    document.getElementById('checkout-modal').classList.add('active');
    document.body.style.overflow = 'hidden';
    renderCheckoutSummary();
    
    // Load saved form data after a brief delay to ensure form is rendered
    setTimeout(() => {
        loadCheckoutFormData();
        initCheckoutAutoSave();
    }, 100);
    
    // Pre-fill user data if logged in (existing code)
    try {
        const user = Auth.getCurrentUser();
        if (user) {
            // Only fill if fields are empty (prioritize saved data)
            if (!document.getElementById('checkout-email').value) {
                document.getElementById('checkout-email').value = user.email || '';
            }
            if (!document.getElementById('checkout-firstname').value) {
                document.getElementById('checkout-firstname').value = user.firstName || '';
            }
            if (!document.getElementById('checkout-lastname').value) {
                document.getElementById('checkout-lastname').value = user.lastName || '';
            }
        }
    } catch(e) {}
}

// UPDATE: closeCheckout to save data when cancelled
function closeCheckout() {
    saveCheckoutFormData(); // Save before closing
    document.getElementById('checkout-modal').classList.remove('active');
    document.body.style.overflow = '';
}

function renderCheckoutSummary() {
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    const itemsContainer = document.getElementById('checkout-items');
    const totalsContainer = document.getElementById('checkout-totals');
    
    // Render items with proper image handling
    let itemsHtml = '';
    cart.forEach(item => {
        const qty = item.quantity || 1;
        const price = item.price || 0;
        const lineTotal = (qty * price).toFixed(2);
        
        // Determine best image source (ENHANCED)
        let imgSrc = '';
        if (item.primaryImage) {
            imgSrc = item.primaryImage;
        } else if (item.image) {
            imgSrc = item.image;
        } else if (item.designThumb) {
            imgSrc = item.designThumb;
        } else if (item.customDesign && item.customDesign.thumbnails) {
            const thumbs = item.customDesign.thumbnails;
            imgSrc = thumbs.front || thumbs[Object.keys(thumbs)[0]] || '';
        } else if (item.thumbnails) {
            imgSrc = item.thumbnails.front || item.thumbnails[Object.keys(item.thumbnails)[0]] || '';
        }
        
        const itemDesc = item.isCustom 
            ? `Custom Design (${item.customDesign?.activeSides?.join(', ') || 'front'})` 
            : `${item.size ? `Size: ${item.size}` : ''} ${item.color ? `| Color: ${item.color}` : ''}`;
        
        itemsHtml += `
            <div class="order-summary-item">
                ${imgSrc ? `
                    <div class="summary-item-img" style="
                        background-image: url('${imgSrc}');
                        background-size: cover;
                        background-position: center;
                        border: 2px solid #e5e7eb;
                        position: relative;
                    ">
                        ${item.isCustom ? '<span style="position: absolute; bottom: 1px; right: 1px; background: #3b82f6; color: white; font-size: 8px; padding: 1px 3px; border-radius: 2px;">CUSTOM</span>' : ''}
                    </div>
                ` : `
                    <div class="summary-item-img">${item.icon || 'üì¶'}</div>
                `}
                
                <div class="summary-item-details">
                    <div class="summary-item-name">${item.name || 'Product'}</div>
                    <div class="summary-item-meta">${itemDesc}</div>
                    <div class="summary-item-meta">Qty: ${qty}</div>
                </div>
                <div class="summary-item-price">$${lineTotal}</div>
            </div>
        `;
    });
    itemsContainer.innerHTML = itemsHtml;
    
    // Calculate totals
    const subtotal = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
    const shipping = subtotal > 75 ? 0 : 1.00;
    const tax = subtotal * 0.01;
    const total = subtotal + shipping + tax;
    
    totalsContainer.innerHTML = `
        <div class="summary-row">
            <span>Subtotal</span>
            <span>$${subtotal.toFixed(2)}</span>
        </div>
        <div class="summary-row">
            <span>Shipping</span>
            <span>${shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2)}</span>
        </div>
        <div class="summary-row">
            <span>Tax (1%)</span>
            <span>$${tax.toFixed(2)}</span>
        </div>
        <div class="summary-row total">
            <span>Total</span>
            <span>$${total.toFixed(2)}</span>
        </div>
    `;
}
function validateCheckoutForm() {
    const email = document.getElementById('checkout-email').value.trim();
    const firstName = document.getElementById('checkout-firstname').value.trim();
    const lastName = document.getElementById('checkout-lastname').value.trim();
    const address = document.getElementById('checkout-address').value.trim();
    const city = document.getElementById('checkout-city').value.trim();
    const zip = document.getElementById('checkout-zip').value.trim();
    
    if (!email || !firstName || !lastName || !address || !city || !zip) {
        alert('Please fill in all required fields');
        return false;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        return false;
    }
    
    return true;
}

// PayPal SDK Integration
function loadPayPalSDK() {
    if (document.getElementById('paypal-sdk')) return Promise.resolve();
    
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.id = 'paypal-sdk';
        script.src = 'https://www.paypal.com/sdk/js?client-id=ARjRdV8XjYuk8l5ykSyKTXYaGGQA9LOfzBtl84LyeQVb5_J5yKG8I-nCB_AhqKqp5H3AhPnStjvgdBHr&currency=AUD';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// Stripe SDK Integration

async function processPayPalPayment() {
    if (!validateCheckoutForm()) return;
    
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    const subtotal = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
    const shipping = subtotal > 75 ? 0 : 1.00;
    const tax = subtotal * 0.01;
    const total = (subtotal + shipping + tax).toFixed(2);
    
    // Disable button
    document.getElementById('paypal-btn').disabled = true;
    document.getElementById('paypal-btn').innerHTML = 'Loading PayPal...';
    
    try {
        // Load PayPal SDK
        await loadPayPalSDK();
        
        // Create PayPal container
        const paymentSection = document.querySelector('.payment-methods');
        paymentSection.innerHTML = '<div id="paypal-button-container" style="margin-top: 1rem;"></div>';
        
        // Render PayPal button
        paypal.Buttons({
            style: {
                layout: 'vertical',
                color: 'blue',
                shape: 'rect',
                label: 'paypal'
            },
            
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: total,
                            currency_code: 'AUD'
                        },
                        description: 'CustomThreads Order',
                        payee: {
                            email_address: 'yacob13579@gmail.com'
                        }
                    }]
                });
            },
            
            onApprove: async function(data, actions) {
                try {
                    const order = await actions.order.capture();
                    
                    // Save order
                    saveOrder('PayPal', total, order.id);
                    
                    // Show success
                    showPaymentSuccess(order.id, 'PayPal');
                } catch(err) {
                    alert('Error processing payment: ' + err.message);
                    location.reload();
                }
            },
            
            onError: function(err) {
                console.error('PayPal Error:', err);
                alert('Payment failed. Please try again.');
                location.reload();
            },
            
            onCancel: function() {
                alert('Payment cancelled');
                location.reload();
            }
        }).render('#paypal-button-container');
        
    } catch (error) {
        console.error('PayPal initialization error:', error);
        alert('Failed to load PayPal. Please refresh and try again.');
        document.getElementById('paypal-btn').disabled = false;
        document.getElementById('paypal-btn').innerHTML = 'Pay with PayPal';
    }
}
async function processStripePayment() {
    if (!validateCheckoutForm()) return;
    
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    const subtotal = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
    const shipping = subtotal > 75 ? 0 : 1.00;
    const tax = subtotal * 0.01;
    const total = (subtotal + shipping + tax).toFixed(2);
    
    // Disable buttons
    document.getElementById('paypal-btn').disabled = true;
    document.getElementById('stripe-btn').disabled = true;
    document.getElementById('stripe-btn').textContent = 'Loading Stripe...';
    
    try {
        // Load Stripe SDK
        await loadStripeSDK();
        
        // Create line items for Stripe Checkout
        const lineItems = cart.map(item => ({
            price_data: {
                currency: 'aud',
                product_data: {
                    name: item.name || 'Custom Product',
                    description: `Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}`,
                },
                unit_amount: Math.round((item.price || 0) * 100), // Convert to cents
            },
            quantity: item.quantity || 1,
        }));
        
        // Add shipping as a line item
        if (shipping > 0) {
            lineItems.push({
                price_data: {
                    currency: 'aud',
                    product_data: {
                        name: 'Shipping',
                    },
                    unit_amount: Math.round(shipping * 100),
                },
                quantity: 1,
            });
        }
        
        // Add tax as a line item
        lineItems.push({
            price_data: {
                currency: 'aud',
                product_data: {
                    name: 'Tax',
                },
                unit_amount: Math.round(tax * 100),
            },
            quantity: 1,
        });
        
        // Redirect to Stripe Checkout
        const stripe = window.stripeInstance;
        
        // Use your Stripe publishable key to create a checkout session
        // You need to create a checkout session via your Stripe Dashboard
        // For now, we'll simulate this
        
        // IMPORTANT: Go to https://dashboard.stripe.com/test/payment-links
        // Create a payment link with your products, then use that URL
        const STRIPE_PAYMENT_LINK = 'https://buy.stripe.com/8x27sD4Yk49tcHF1FEgUM01'; // Replace with your actual payment link
        
        // Store pending order data
        const pendingOrder = {
            id: 'STRIPE-' + Date.now(),
            cart: cart,
            total: total,
            customer: {
                email: document.getElementById('checkout-email').value,
                firstName: document.getElementById('checkout-firstname').value,
                lastName: document.getElementById('checkout-lastname').value,
                address: document.getElementById('checkout-address').value,
                city: document.getElementById('checkout-city').value,
                zip: document.getElementById('checkout-zip').value,
            },
            timestamp: Date.now()
        };
        
        localStorage.setItem('ct_pending_stripe_order', JSON.stringify(pendingOrder));
        
        // Redirect to Stripe Payment Link
        window.location.href = STRIPE_PAYMENT_LINK;
        
    } catch (error) {
        console.error('Stripe Error:', error);
        alert('Failed to initialize Stripe payment. Please try again or use PayPal.');
        document.getElementById('paypal-btn').disabled = false;
        document.getElementById('stripe-btn').disabled = false;
        document.getElementById('stripe-btn').textContent = 'Pay with Stripe';
    }
}

    // Check for Stripe success on page load
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('payment') === 'success' || urlParams.get('session_id')) {
        // Stripe payment successful
        const pendingOrder = JSON.parse(localStorage.getItem('ct_pending_stripe_order') || '{}');
        if (pendingOrder.cart) {
            saveOrder('Stripe', pendingOrder.total, urlParams.get('session_id') || 'STRIPE-' + Date.now());
            localStorage.removeItem('ct_pending_stripe_order');
            alert('Payment successful! Thank you for your order.');
        }
    }
});

function redirectToStripeCheckout(total, cart) {
    // This requires setting up Stripe Checkout on your backend
    // For now, show instructions
    const customerEmail = document.getElementById('checkout-email').value;
    
    // Create a temporary order
    const tempOrder = {
        id: 'TEMP-' + Date.now(),
        amount: total,
        email: customerEmail,
        items: cart
    };
    
    localStorage.setItem('ct_pending_stripe_order', JSON.stringify(tempOrder));
    
    // Redirect to Stripe Payment Link (you need to create this in Stripe Dashboard)
    const stripePaymentLink = 'https://buy.stripe.com/test_XXXXXX'; // Replace with your link
    
    alert('You will be redirected to Stripe to complete payment.\n\nTotal: $' + total);
    
    // For testing: simulate payment
    setTimeout(() => {
        const pending = JSON.parse(localStorage.getItem('ct_pending_stripe_order') || '{}');
        if (pending.id) {
            saveOrder('Stripe', pending.amount, pending.id);
            showPaymentSuccess(pending.id, 'Stripe');
            localStorage.removeItem('ct_pending_stripe_order');
        }
    }, 2000);
    
    // window.location.href = stripePaymentLink; // Uncomment when you have the link
}

function showPaymentSuccess(transactionId, method) {
    clearCheckoutFormData(); // Clear saved data on successful payment
    
    const modal = document.getElementById('checkout-modal');
    modal.querySelector('.checkout-body').innerHTML = `
        <div style="text-align: center; padding: 3rem;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">‚úÖ</div>
            <h2 style="margin-bottom: 1rem;">Payment Successful!</h2>
            <p style="color: #6b7280; margin-bottom: 0.5rem;">Your order has been confirmed</p>
            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>Transaction ID:</strong> ${transactionId}</p>
            <p style="color: #6b7280; margin-bottom: 1.5rem;"><strong>Payment Method:</strong> ${method}</p>
            <button class="auth-btn" onclick="closeCheckout(); window.location.reload();">Continue Shopping</button>
        </div>
    `;
}

// UPDATE: saveOrder function to clear form data after saving order
function saveOrder(method, total, transactionId) {
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    
    const order = {
        id: 'ORD-' + Date.now(),
        transactionId: transactionId || 'TXN-' + Date.now(),
        date: new Date().toISOString(),
        items: cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price || 0,
            quantity: item.quantity || 1,
            icon: item.icon || 'üì¶',
            size: item.size || 'N/A',
            color: item.color || 'N/A',
            customDesign: item.customDesign || null,
            primaryImage: item.primaryImage || null,
            thumbnails: item.thumbnails || null,
            designThumb: item.designThumb || null
        })),
        total: parseFloat(total),
        paymentMethod: method,
        customer: {
            email: document.getElementById('checkout-email')?.value || '',
            firstName: document.getElementById('checkout-firstname')?.value || '',
            lastName: document.getElementById('checkout-lastname')?.value || '',
            address: document.getElementById('checkout-address')?.value || '',
            city: document.getElementById('checkout-city')?.value || '',
            zip: document.getElementById('checkout-zip')?.value || '',
            country: document.getElementById('checkout-country')?.value || 'US',
            phone: document.getElementById('checkout-phone')?.value || ''
        },
        status: 'paid'
    };
    
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    orders.push(order);
    localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
    
    localStorage.setItem('ct_cart_v1', '[]');
    updateCartCount();
    
    clearCheckoutFormData(); // Clear saved form data after successful order
    
    return order;
}
    // ===== CHECKOUT FORM AUTO-SAVE FUNCTIONS =====

// Save checkout form data to localStorage
function saveCheckoutFormData() {
    const formData = {
        email: document.getElementById('checkout-email')?.value || '',
        firstName: document.getElementById('checkout-firstname')?.value || '',
        lastName: document.getElementById('checkout-lastname')?.value || '',
        address: document.getElementById('checkout-address')?.value || '',
        city: document.getElementById('checkout-city')?.value || '',
        zip: document.getElementById('checkout-zip')?.value || '',
        country: document.getElementById('checkout-country')?.value || 'US',
        phone: document.getElementById('checkout-phone')?.value || ''
    };
    
    localStorage.setItem('ct_checkout_form', JSON.stringify(formData));
}

// Load saved checkout form data
function loadCheckoutFormData() {
    const savedData = localStorage.getItem('ct_checkout_form');
    if (!savedData) return;
    
    try {
        const formData = JSON.parse(savedData);
        
        if (document.getElementById('checkout-email')) {
            document.getElementById('checkout-email').value = formData.email || '';
            document.getElementById('checkout-firstname').value = formData.firstName || '';
            document.getElementById('checkout-lastname').value = formData.lastName || '';
            document.getElementById('checkout-address').value = formData.address || '';
            document.getElementById('checkout-city').value = formData.city || '';
            document.getElementById('checkout-zip').value = formData.zip || '';
            document.getElementById('checkout-country').value = formData.country || 'US';
            document.getElementById('checkout-phone').value = formData.phone || '';
        }
    } catch(e) {
        console.error('Error loading checkout form data:', e);
    }
}

// Clear saved checkout form data
function clearCheckoutFormData() {
    localStorage.removeItem('ct_checkout_form');
}

// Add auto-save on form field changes
function initCheckoutAutoSave() {
    const formFields = [
        'checkout-email',
        'checkout-firstname', 
        'checkout-lastname',
        'checkout-address',
        'checkout-city',
        'checkout-zip',
        'checkout-country',
        'checkout-phone'
    ];
    
    formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('blur', saveCheckoutFormData);
            field.addEventListener('change', saveCheckoutFormData);
        }
    });
}
    
    // Add this to new.html for testing
function testOrderConnection() {
    // Create a test order
    const testOrder = {
        id: 'TEST-' + Date.now(),
        date: new Date().toISOString(),
        items: [{
            name: 'Test Custom Design',
            price: 29.99,
            quantity: 1,
            icon: 'üé®',
            customDesign: { test: true }
        }],
        total: 29.99,
        paymentMethod: 'Test',
        customer: {
            firstName: 'Test',
            lastName: 'User',
            email: 'test@example.com'
        },
        status: 'paid'
    };
    
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    orders.push(testOrder);
    localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
    
    alert('Test order created! Check order.html');
    window.open('#', '_blank');
}
function saveOrder(method, total) {
    
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    const order = {
        id: 'ORD-' + Date.now(),
        date: new Date().toISOString(),
        items: cart,
        total: parseFloat(total),
        paymentMethod: method,
        customer: {
            email: document.getElementById('checkout-email').value,
            firstName: document.getElementById('checkout-firstname').value,
            lastName: document.getElementById('checkout-lastname').value,
            address: document.getElementById('checkout-address').value,
            city: document.getElementById('checkout-city').value,
            zip: document.getElementById('checkout-zip').value,
            country: document.getElementById('checkout-country').value,
            phone: document.getElementById('checkout-phone').value
        }
    };
    
    // Save to order history
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    orders.push(order);
    localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
    
    // Clear cart
    localStorage.setItem('ct_cart_v1', '[]');
    updateCartCount();
    
    // Show success
    setTimeout(() => {
        closeCheckout();
        alert('Order placed successfully! Order ID: ' + order.id);
    }, 1500);
}
   

// Advanced Account System
// Enhanced Account System Functions

function showAccount() {
    const user = Auth.getCurrentUser();
    const modal = document.getElementById('account-modal');
    const content = document.getElementById('account-content');
    const title = document.getElementById('account-title');
    
    if (!user) {
        title.textContent = 'Welcome Back';
        content.innerHTML = renderSignInForm();
    } else {
        title.textContent = `Welcome, ${user.firstName}`;
        content.innerHTML = renderAccountDashboard(user);
    }
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function renderAccountDashboard(user) {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const completedOrders = orders.filter(o => o.status === 'completed' || o.status === 'paid').length;
    const processingOrders = orders.filter(o => o.status === 'processing').length;
    const savedDesigns = localStorage.getItem('ct_design_saved') ? 1 : 0;
    
    return `
        <div class="welcome-banner">
            <h3>Hello, ${user.firstName} ${user.lastName}!</h3>
            <p>${user.email}</p>
        </div>
        
        <div class="account-menu">
          <div class="account-menu-item" onclick="window.location.href='#'">
    <div class="account-menu-icon">üì¶</div>
    <div class="account-menu-content">
        <div class="account-menu-title">My Orders</div>
        <div class="account-menu-desc">${orders.length} total orders ‚Ä¢ ${processingOrders} active</div>
    </div>
</div>
            
            <div class="account-menu-item" onclick="showSavedDesigns()">
                <div class="account-menu-icon">üé®</div>
                <div class="account-menu-content">
                    <div class="account-menu-title">Saved Designs</div>
                    <div class="account-menu-desc">${savedDesigns} custom design${savedDesigns !== 1 ? 's' : ''} saved</div>
                </div>
            </div>
            
            <div class="account-menu-item" onclick="showProfileSettings()">
                <div class="account-menu-icon">‚öôÔ∏è</div>
                <div class="account-menu-content">
                    <div class="account-menu-title">Profile Settings</div>
                    <div class="account-menu-desc">Update your account information</div>
                </div>
            </div>
            
            <div class="account-menu-item" onclick="showAddresses()">
                <div class="account-menu-icon">üìç</div>
                <div class="account-menu-content">
                    <div class="account-menu-title">Saved Addresses</div>
                    <div class="account-menu-desc">Manage shipping addresses</div>
                </div>
            </div>
            
            <div class="account-menu-item" onclick="handleSignOut()">
                <div class="account-menu-icon">üö™</div>
                <div class="account-menu-content">
                    <div class="account-menu-title" style="color: #dc2626;">Sign Out</div>
                    <div class="account-menu-desc">Log out of your account</div>
                </div>
            </div>
        </div>
    `;
}

function showOrderHistory() {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    document.getElementById('account-title').textContent = 'Order History';
    
    if (orders.length === 0) {
        document.getElementById('account-content').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>No orders yet</h3>
                <p>Your order history will appear here once you make your first purchase</p>
                <button class="auth-btn" onclick="closeAccountModal()">Start Shopping</button>
            </div>
        `;
        return;
    }
    
    let html = '';
    orders.reverse().forEach(order => {
        const date = new Date(order.date).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        const status = order.status || 'completed';
        const itemCount = order.items.length;
        
        html += `
            <div class="order-card">
                <div class="order-header">
                    <div>
                        <div class="order-id">${order.id}</div>
                        <div class="order-date">${date}</div>
                    </div>
                    <div>
                        <div class="order-status ${status}">${status}</div>
                        <div class="order-total-display">$${order.total.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="order-items-preview">
                    ${order.items.slice(0, 3).map(item => `
                        <div class="order-item-mini">
                            <span class="order-item-mini-icon">${item.icon || 'üì¶'}</span>
                            <span>${item.name || 'Product'}</span>
                        </div>
                    `).join('')}
                    ${itemCount > 3 ? `<div class="order-item-mini">+${itemCount - 3} more</div>` : ''}
                </div>
                
                <div class="order-actions">
                    <button class="order-action-btn primary" onclick="viewOrderDetail('${order.id}')">View Details</button>
                    ${status === 'processing' ? `
                        <button class="order-action-btn danger" onclick="confirmCancelOrder('${order.id}')">Cancel Order</button>
                    ` : ''}
                    <button class="order-action-btn secondary" onclick="reorderItems('${order.id}')">Reorder</button>
                </div>
            </div>
        `;
    });
    
    html += '<button class="auth-btn auth-btn-secondary" onclick="showAccount()">‚Üê Back to Dashboard</button>';
    document.getElementById('account-content').innerHTML = html;
}

function viewOrderDetail(orderId) {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const order = orders.find(o => o.id === orderId);
    
    if (!order) {
        alert('Order not found');
        return;
    }
    
    document.getElementById('account-title').textContent = 'Order Details';
    
    const date = new Date(order.date).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const status = order.status || 'completed';
    const subtotal = order.items.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
    const shipping = subtotal > 75 ? 0 : 1.00;
    const tax = subtotal * 0.01;
    
    const html = `
        <div class="order-detail">
            <div class="order-detail-header">
                <div>
                    <div class="order-id">${order.id}</div>
                    <div class="order-date">${date}</div>
                </div>
                <div class="order-status ${status}">${status}</div>
            </div>
            
            ${order.customer ? `
                <div style="background: #f9fafb; padding: 1.25rem; border-radius: 12px; margin-bottom: 2rem;">
                    <h4 style="margin: 0 0 0.75rem 0; color: #1a1a1a;">Shipping Information</h4>
                    <p style="margin: 0.25rem 0; color: #6b7280; font-size: 0.925rem;">
                        <strong>${order.customer.firstName} ${order.customer.lastName}</strong><br>
                        ${order.customer.address}<br>
                        ${order.customer.city}, ${order.customer.zip}<br>
                        ${order.customer.email}
                        ${order.customer.phone ? `<br>${order.customer.phone}` : ''}
                    </p>
                </div>
            ` : ''}
            
            <h4 style="margin: 0 0 1rem 0; color: #1a1a1a;">Order Items</h4>
            <div class="order-detail-items">
                ${order.items.map(item => {
                    const qty = item.quantity || 1;
                    const price = item.price || 0;
                    const lineTotal = (qty * price).toFixed(2);
                    
                    return `
                        <div class="order-detail-item">
                            <div class="order-detail-item-img">${item.icon || 'üì¶'}</div>
                            <div class="order-detail-item-info">
                                <div class="order-detail-item-name">${item.name || 'Product'}</div>
                                <div class="order-detail-item-meta">
                                    Quantity: ${qty}
                                    ${item.size ? ` ‚Ä¢ Size: ${item.size}` : ''}
                                    ${item.color ? ` ‚Ä¢ Color: ${item.color}` : ''}
                                </div>
                                <div class="order-detail-item-price">$${lineTotal}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div class="order-summary-totals">
                <div class="order-summary-row">
                    <span>Subtotal</span>
                    <span>$${subtotal.toFixed(2)}</span>
                </div>
                <div class="order-summary-row">
                    <span>Shipping</span>
                    <span>${shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2)}</span>
                </div>
                <div class="order-summary-row">
                    <span>Tax</span>
                    <span>$${tax.toFixed(2)}</span>
                </div>
                <div class="order-summary-row total">
                    <span>Total</span>
                    <span>$${order.total.toFixed(2)}</span>
                </div>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 0.75rem;">
                ${status === 'processing' ? `
                    <button class="order-action-btn danger" onclick="confirmCancelOrder('${order.id}')">Cancel Order</button>
                ` : ''}
                <button class="order-action-btn secondary" onclick="reorderItems('${order.id}')">Reorder Items</button>
                <button class="auth-btn auth-btn-secondary" onclick="showOrderHistory()">‚Üê Back to Orders</button>
            </div>
        </div>
    `;
    
    document.getElementById('account-content').innerHTML = html;
}

function confirmCancelOrder(orderId) {
    if (confirm('Are you sure you want to cancel this order? This action cannot be undone.')) {
        cancelOrder(orderId);
    }
}

function cancelOrder(orderId) {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
        orders[orderIndex].status = 'cancelled';
        localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
        
        alert('Order cancelled successfully. Refund will be processed within 3-5 business days.');
        viewOrderDetail(orderId); // Refresh the view
    }
}

function reorderItems(orderId) {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const order = orders.find(o => o.id === orderId);
    
    if (!order) return;
    
    const cart = JSON.parse(localStorage.getItem('ct_cart_v1') || '[]');
    order.items.forEach(item => {
        cart.push({...item, id: Date.now() + Math.random()});
    });
    
    localStorage.setItem('ct_cart_v1', JSON.stringify(cart));
    updateCartCount();
    
    closeAccountModal();
    alert(`${order.items.length} item(s) added to cart!`);
}

function showAddresses() {
    document.getElementById('account-title').textContent = 'Saved Addresses';
    
    document.getElementById('account-content').innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üìç</div>
            <h3>No saved addresses</h3>
            <p>Save addresses during checkout for faster ordering</p>
            <button class="auth-btn auth-btn-secondary" onclick="showAccount()">‚Üê Back to Dashboard</button>
        </div>
    `;
}

    function renderSignInForm() {
    return `
        <form class="auth-form" onsubmit="handleSignIn(event)">
            <input type="email" class="auth-input" placeholder="Email address" name="email" required>
            <input type="password" class="auth-input" placeholder="Password" name="password" required>
            <div id="auth-message"></div>
            <button type="submit" class="auth-btn">Sign In</button>
            <div class="auth-link" onclick="showForgotPassword()">Forgot password?</div>
            <div class="auth-divider">or</div>
            <button type="button" class="auth-btn auth-btn-secondary" onclick="showSignUpForm()">Create Account</button>
        </form>
    `;
}

    function handleSignIn(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const email = formData.get('email').trim();
    const password = formData.get('password');
    
    const result = Auth.signIn(email, password);
    const msgEl = document.getElementById('auth-message');
    
    if (result.success) {
        msgEl.innerHTML = '<div class="success-message">Sign in successful!</div>';
        setTimeout(() => showAccount(), 800);
    } else {
        msgEl.innerHTML = `<div class="error-message">${result.message}</div>`;
    }
}


    function showSignUpForm() {
    document.getElementById('account-title').textContent = 'Create Account';
    document.getElementById('account-content').innerHTML = `
        <form class="auth-form" onsubmit="handleSignUp(event)">
            <input type="text" class="auth-input" placeholder="First Name" name="firstName" required>
            <input type="text" class="auth-input" placeholder="Last Name" name="lastName" required>
            <input type="email" class="auth-input" placeholder="Email address" name="email" required>
            <input type="password" class="auth-input" placeholder="Password (min 8 characters)" name="password" minlength="8" required>
            <input type="password" class="auth-input" placeholder="Confirm Password" name="confirmPassword" required>
            <div id="auth-message"></div>
            <button type="submit" class="auth-btn">Create Account</button>
            <div class="auth-link" onclick="showAccount()">Already have an account? Sign in</div>
        </form>
    `;
}

    function handleSignUp(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const firstName = formData.get('firstName').trim();
    const lastName = formData.get('lastName').trim();
    const email = formData.get('email').trim();
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');
    
    const msgEl = document.getElementById('auth-message');
    
    if (password !== confirmPassword) {
        msgEl.innerHTML = '<div class="error-message">Passwords do not match</div>';
        return;
    }
    
    if (password.length < 8) {
        msgEl.innerHTML = '<div class="error-message">Password must be at least 8 characters</div>';
        return;
    }
    
    const result = Auth.signUp(email, password, firstName, lastName);
    
    if (result.success) {
        msgEl.innerHTML = '<div class="success-message">Account created successfully!</div>';
        setTimeout(() => showAccount(), 800);
    } else {
        msgEl.innerHTML = `<div class="error-message">${result.message}</div>`;
    }
}

    function handleSignOut() {
    if (confirm('Are you sure you want to sign out?')) {
        Auth.signOut();
        showAccount();
    }
}

    function closeAccountModal() {
    document.getElementById('account-modal').classList.remove('active');
    document.body.style.overflow = '';
}

    function showForgotPassword() {
    document.getElementById('account-title').textContent = 'Reset Password';
    document.getElementById('account-content').innerHTML = `
        <form class="auth-form" onsubmit="handleForgotPassword(event)">
            <p style="color: #6b7280; margin-bottom: 1rem;">Enter your email to reset your password</p>
            <input type="email" class="auth-input" placeholder="Email address" name="email" required>
            <div id="auth-message"></div>
            <button type="submit" class="auth-btn">Continue</button>
            <div class="auth-link" onclick="showAccount()">Back to sign in</div>
        </form>
    `;
}

function handleForgotPassword(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const email = formData.get('email').trim();
    const msgEl = document.getElementById('auth-message');
    
    const userExists = Auth.emailExists(email);
    
    if (!userExists) {
        msgEl.innerHTML = '<div class="error-message">No account found with this email address</div>';
        return;
    }
    
    // Show password reset form
    document.getElementById('account-title').textContent = 'Reset Password';
    document.getElementById('account-content').innerHTML = `
        <form class="auth-form" onsubmit="handlePasswordReset(event, '${email}')">
            <p style="color: #6b7280; margin-bottom: 1rem;">Set a new password for <strong>${email}</strong></p>
            <input type="password" class="auth-input" placeholder="New Password (min 8 characters)" name="newPassword" minlength="8" required>
            <input type="password" class="auth-input" placeholder="Confirm New Password" name="confirmPassword" required>
            <div id="auth-message"></div>
            <button type="submit" class="auth-btn">Reset Password</button>
            <div class="auth-link" onclick="showAccount()">Cancel</div>
        </form>
    `;
}

function handlePasswordReset(e, email) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newPassword = formData.get('newPassword');
    const confirmPassword = formData.get('confirmPassword');
    const msgEl = document.getElementById('auth-message');
    
    if (newPassword !== confirmPassword) {
        msgEl.innerHTML = '<div class="error-message">Passwords do not match</div>';
        return;
    }
    
    if (newPassword.length < 8) {
        msgEl.innerHTML = '<div class="error-message">Password must be at least 8 characters</div>';
        return;
    }
    
    const result = Auth.resetPassword(email, newPassword);
    
    if (result.success) {
        msgEl.innerHTML = '<div class="success-message">Password reset successful! Please sign in.</div>';
        setTimeout(() => showAccount(), 1500);
    } else {
        msgEl.innerHTML = `<div class="error-message">${result.message}</div>`;
    }
}


    function showProfileSettings() {
    const user = Auth.getCurrentUser();
    document.getElementById('account-title').textContent = 'Profile Settings';
    
    document.getElementById('account-content').innerHTML = `
        <form class="auth-form" onsubmit="handleProfileUpdate(event)">
            <input type="text" class="auth-input" placeholder="First Name" name="firstName" value="${user.firstName || ''}" required>
            <input type="text" class="auth-input" placeholder="Last Name" name="lastName" value="${user.lastName || ''}" required>
            <input type="email" class="auth-input" placeholder="Email" name="email" value="${user.email || ''}" required>
            <div id="auth-message"></div>
            <button type="submit" class="auth-btn">Save Changes</button>
            <button type="button" class="auth-btn auth-btn-secondary" onclick="showAccount()">Cancel</button>
        </form>
    `;
}

function handleProfileUpdate(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const updates = {
        firstName: formData.get('firstName').trim(),
        lastName: formData.get('lastName').trim(),
        email: formData.get('email').trim()
    };
    
    const result = Auth.updateUser(updates);
    const msgEl = document.getElementById('auth-message');
    
    if (result.success) {
        msgEl.innerHTML = '<div class="success-message">Profile updated successfully!</div>';
        setTimeout(() => showAccount(), 1000);
    } else {
        msgEl.innerHTML = `<div class="error-message">${result.message}</div>`;
    }
}

    // Admin Order Management Functions

function showAdminOrders() {
    const modal = document.getElementById('admin-orders-modal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    renderAdminOrders();
}

function closeAdminOrders() {
    document.getElementById('admin-orders-modal').classList.remove('active');
    document.body.style.overflow = '';
}

function renderAdminOrders() {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const content = document.getElementById('admin-orders-content');
    
    if (orders.length === 0) {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h3>No orders found</h3>
                <p>Orders will appear here once customers make purchases</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0;">Total Orders: ${orders.length}</h3>
                <p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.925rem;">
                    Active: ${orders.filter(o => o.status === 'processing' || o.status === 'paid').length} | 
                    Completed: ${orders.filter(o => o.status === 'completed').length} | 
                    Cancelled: ${orders.filter(o => o.status === 'cancelled').length}
                </p>
            </div>
            <button class="order-action-btn danger" onclick="confirmClearAllOrders()" style="padding: 0.75rem 1.25rem;">
                Clear All Orders
            </button>
        </div>
    `;
    
    orders.reverse().forEach(order => {
        const date = new Date(order.date).toLocaleString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        const status = order.status || 'completed';
        
        html += `
            <div class="order-card" style="margin-bottom: 1.25rem;">
                <div class="order-header">
                    <div>
                        <div class="order-id">${order.id}</div>
                        <div class="order-date">${date}</div>
                        ${order.transactionId ? `<div style="font-size: 0.8rem; color: #9ca3af; margin-top: 0.25rem;">Transaction: ${order.transactionId}</div>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div class="order-status ${status}">${status}</div>
                        <div class="order-total-display" style="margin-top: 0.5rem;">$${order.total.toFixed(2)}</div>
                        <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">${order.paymentMethod || 'N/A'}</div>
                    </div>
                </div>
                
                ${order.customer ? `
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                        <strong>${order.customer.firstName || ''} ${order.customer.lastName || ''}</strong><br>
                        ${order.customer.email || ''}<br>
                        ${order.customer.address || ''}, ${order.customer.city || ''} ${order.customer.zip || ''}<br>
                        ${order.customer.phone || ''}
                    </div>
                ` : ''}
                
                <div style="margin: 1rem 0;">
                    <strong style="display: block; margin-bottom: 0.5rem;">Items (${order.items.length}):</strong>
                    ${order.items.map(item => `
                        <div style="padding: 0.5rem; background: #f9fafb; border-radius: 6px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 0.875rem;">
                            <span>${item.icon || 'üì¶'} ${item.name || 'Product'} ${item.size ? `(${item.size})` : ''}</span>
                            <span>Qty: ${item.quantity || 1} √ó $${(item.price || 0).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="order-actions" style="gap: 0.5rem;">
                    <select onchange="updateOrderStatus('${order.id}', this.value)" style="padding: 0.6rem 1rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem;">
                        <option value="">Change Status...</option>
                        <option value="processing" ${status === 'processing' ? 'selected' : ''}>Processing</option>
                        <option value="paid" ${status === 'paid' ? 'selected' : ''}>Paid</option>
                        <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                    
                    <button class="order-action-btn primary" onclick="editOrderDetails('${order.id}')">
                        Edit Details
                    </button>
                    
                    <button class="order-action-btn danger" onclick="confirmDeleteOrder('${order.id}')">
                        Delete Order
                    </button>
                </div>
            </div>
        `;
    });
    
    content.innerHTML = html;
}

function updateOrderStatus(orderId, newStatus) {
    if (!newStatus) return;
    
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
        orders[orderIndex].status = newStatus;
        localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
        showMessage(`Order ${orderId} status updated to: ${newStatus}`);
        renderAdminOrders();
    }
}

function editOrderDetails(orderId) {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const order = orders.find(o => o.id === orderId);
    
    if (!order) return;
    
    const content = document.getElementById('admin-orders-content');
    
    content.innerHTML = `
        <h3 style="margin-bottom: 1.5rem;">Edit Order: ${order.id}</h3>
        
        <form onsubmit="saveOrderEdits(event, '${orderId}')" style="display: grid; gap: 1rem;">
            <div class="form-field">
                <label>Order Total ($)</label>
                <input type="number" step="0.01" name="total" value="${order.total}" required style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
            </div>
            
            <div class="form-field">
                <label>Customer Email</label>
                <input type="email" name="email" value="${order.customer?.email || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-field">
                    <label>First Name</label>
                    <input type="text" name="firstName" value="${order.customer?.firstName || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                </div>
                <div class="form-field">
                    <label>Last Name</label>
                    <input type="text" name="lastName" value="${order.customer?.lastName || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                </div>
            </div>
            
            <div class="form-field">
                <label>Shipping Address</label>
                <input type="text" name="address" value="${order.customer?.address || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-field">
                    <label>City</label>
                    <input type="text" name="city" value="${order.customer?.city || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                </div>
                <div class="form-field">
                    <label>ZIP Code</label>
                    <input type="text" name="zip" value="${order.customer?.zip || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                </div>
            </div>
            
            <div class="form-field">
                <label>Phone</label>
                <input type="tel" name="phone" value="${order.customer?.phone || ''}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px;">
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                <button type="submit" class="auth-btn" style="flex: 1;">Save Changes</button>
                <button type="button" class="auth-btn auth-btn-secondary" style="flex: 1;" onclick="renderAdminOrders()">Cancel</button>
            </div>
        </form>
    `;
}

function saveOrderEdits(e, orderId) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
        orders[orderIndex].total = parseFloat(formData.get('total'));
        orders[orderIndex].customer = {
            ...orders[orderIndex].customer,
            email: formData.get('email'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            address: formData.get('address'),
            city: formData.get('city'),
            zip: formData.get('zip'),
            phone: formData.get('phone')
        };
        
        localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
        showMessage('Order updated successfully!');
        renderAdminOrders();
    }
}

function confirmDeleteOrder(orderId) {
    if (confirm(`Are you sure you want to permanently delete order ${orderId}? This action cannot be undone.`)) {
        deleteOrder(orderId);
    }
}

function deleteOrder(orderId) {
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    const filtered = orders.filter(o => o.id !== orderId);
    localStorage.setItem('ct_orders_v1', JSON.stringify(filtered));
    showMessage('Order deleted successfully');
    renderAdminOrders();
}

function confirmClearAllOrders() {
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL orders. This action cannot be undone.\n\nAre you absolutely sure?')) {
        if (confirm('Final confirmation: Delete all ' + JSON.parse(localStorage.getItem('ct_orders_v1') || '[]').length + ' orders?')) {
            localStorage.setItem('ct_orders_v1', '[]');
            showMessage('All orders have been cleared');
            renderAdminOrders();
        }
    }
}

// Add access button to footer - call this function to open admin panel
window.showAdminOrders = showAdminOrders;


    // Test function - remove after testing
window.testOrderCreation = function() {
    const testOrder = {
        id: 'TEST-' + Date.now(),
        transactionId: 'TXN-TEST-' + Date.now(),
        date: new Date().toISOString(),
        items: [{
            name: 'Test Custom T-Shirt',
            price: 29.99,
            quantity: 1,
            icon: 'üëï',
            size: 'M',
            color: 'Black',
            designThumb: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzY2N2VlYSIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1zaXplPSIzMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPlRFU1Q8L3RleHQ+PC9zdmc+'
        }],
        total: 29.99,
        paymentMethod: 'Test',
        customer: {
            firstName: 'Test',
            lastName: 'User',
            email: 'test@example.com',
            address: '123 Test St',
            city: 'Test City',
            zip: '12345'
        },
        status: 'paid'
    };
    
    const orders = JSON.parse(localStorage.getItem('ct_orders_v1') || '[]');
    orders.push(testOrder);
    localStorage.setItem('ct_orders_v1', JSON.stringify(orders));
    
    alert('Test order created! Open order.html to see it.');
    console.log('Test order:', testOrder);
};
</script>

    
    <!-- Advanced Cart Modal -->
<div class="cart-overlay" id="cart-overlay" onclick="closeAdvancedCart()"></div>
<div id="advanced-cart-modal">
    <div class="cart-header">
        <h2>Shopping Cart</h2>
        <button class="cart-close-btn" onclick="closeAdvancedCart()">√ó</button>
    </div>
    <div class="cart-body" id="advanced-cart-body">
        <!-- Cart items will be rendered here -->
    </div>
    <div class="cart-footer" id="advanced-cart-footer">
        <!-- Cart summary will be rendered here -->
    </div>
</div>

    <!-- Advanced Checkout Modal -->
<div class="checkout-modal-overlay" id="checkout-modal">
    <div class="checkout-modal-content">
        <div class="checkout-header">
            <h2>Secure Checkout</h2>
            <button class="cart-close-btn" onclick="closeCheckout()">√ó</button>
        </div>
        <div class="checkout-body">
            <div>
                <div class="checkout-section">
                    <h3>Contact Information</h3>
                    <div class="form-field">
                        <label>Email *</label>
                        <input type="email" id="checkout-email" placeholder="your@email.com" required>
                    </div>
                </div>
                
                <div class="checkout-section" style="margin-top: 1.5rem;">
                    <h3>Shipping Address</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label>First Name *</label>
                            <input type="text" id="checkout-firstname" required>
                        </div>
                        <div class="form-field">
                            <label>Last Name *</label>
                            <input type="text" id="checkout-lastname" required>
                        </div>
                    </div>
                    <div class="form-field">
                        <label>Address *</label>
                        <input type="text" id="checkout-address" placeholder="Street address" required>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label>City *</label>
                            <input type="text" id="checkout-city" required>
                        </div>
                        <div class="form-field">
                            <label>ZIP Code *</label>
                            <input type="text" id="checkout-zip" required>
                        </div>
                    </div>
                    <div class="form-field">
                        <label>Country *</label>
                        <select id="checkout-country" required>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Phone</label>
                        <input type="tel" id="checkout-phone" placeholder="(555) 123-4567">
                    </div>
                </div>
            </div>
            
            <div>
                <div class="checkout-section">
                    <h3>Order Summary</h3>
                    <div id="checkout-items"></div>
                    <div class="summary-totals" id="checkout-totals"></div>
                </div>
                
<div class="payment-methods">
    <button class="payment-method-btn paypal" onclick="processPayPalPayment()" id="paypal-btn" style="width: 100%;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 0 0-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 0 0 .554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.76-4.852a.93.93 0 0 1 .922-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.844-4.463z"/>
        </svg>
        Pay with PayPal
    </button>
    <p style="text-align: center; color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">
        Secure payment powered by PayPal
    </p>
</div>
            </div>
        </div>
    </div>
</div>
    <!-- Advanced Account Modal -->
<div class="account-modal" id="account-modal">
    <div class="account-card">
        <div class="account-header">
            <h2 id="account-title">My Account</h2>
            <button class="cart-close-btn" onclick="closeAccountModal()">√ó</button>
        </div>
        <div class="account-body" id="account-content">
            <!-- Content will be dynamically loaded -->
        </div>
    </div>
</div>
    <!-- Admin Order Management Modal -->
</body>
</html>


              